{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "769c6a1c-f2fa-46cd-8461-7fa08eba3197",
        "options": {}
      },
      "id": "928bb058-eacd-46bd-b856-f59871dfda1a",
      "name": "Hono Webhook1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -512,
        1936
      ],
      "webhookId": "769c6a1c-f2fa-46cd-8461-7fa08eba3197",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6449d97d-0856-4597-88d3-1573f10600a0",
              "name": "Topic",
              "value": "={{ $json.body.topic }}",
              "type": "string"
            },
            {
              "id": "0aa8068d-6d0c-4607-951f-710b9bca4fe5",
              "name": "Keywords",
              "value": "={{ $json.body.keywords }}",
              "type": "string"
            },
            {
              "id": "777988e0-af1c-4ede-bd2d-fe9d6125810e",
              "name": "total_word_count",
              "value": "={{ $json.body.totalWordCount }}",
              "type": "string"
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "name": "taskId",
              "value": "={{ $json.body.taskId }}",
              "type": "string"
            },
            {
              "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
              "name": "coverPromptId",
              "value": "={{ $json.body.coverPromptId }}",
              "type": "string"
            },
            {
              "id": "e44ad556-83b3-4c77-a3e2-3481cee4d2f2",
              "name": "useSearch",
              "value": "={{ $json.body.useSearch }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -288,
        1648
      ],
      "id": "93cb8346-b3eb-402e-9dd5-0bcca874de1e",
      "name": "创作主题1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM style_analyses\n WHERE id = '{{ $json.body.refMaterialId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -288,
        1840
      ],
      "id": "86c07fca-783c-41cd-a0c8-6293ab8df6e1",
      "name": "创作风格要求1",
      "credentials": {
        "postgres": {
          "id": "XTSDl3uToEpo9ujr",
          "name": "media-ops"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM image_prompts WHERE id = '{{ $json.body.coverPromptId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -288,
        2032
      ],
      "id": "6e0c1f26-f3f7-4583-9f96-fde515cde396",
      "name": "封面图要求1",
      "credentials": {
        "postgres": {
          "id": "XTSDl3uToEpo9ujr",
          "name": "media-ops"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 4,
        "options": {
          "includeUnpaired": false
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -64,
        1904
      ],
      "id": "89f9000c-43e5-4a4c-9ab9-d9a8fa6a242b",
      "name": "创作变量"
    },
    {
      "parameters": {
        "jsCode": "// 获取 \"创作变量\" 节点的输出\nconst creationVars = $('创作变量').first().json;\n\n// 获取当前输入的搜索素材\nconst searchMaterial = items[0].json.search_material || \"无外部搜索素材\";\n\n// --- 1. 提取全局宪法 (Global Style DNA) ---\nconst globalDNA = {\n  persona: creationVars.style_identity_data,\n  constraints: creationVars.metrics_constraints_data,\n  lexical: creationVars.lexical_logic_data,\n  rhetoric: creationVars.rhetoric_logic_data,\n  anti_patterns: creationVars.anti_patterns_data,\n  golden_sample: creationVars.golden_sample_data,\n  search_material: searchMaterial,  // 注入搜索素材\n  topic_meta: {\n    topic: creationVars.Topic,\n    keywords: creationVars.Keywords,\n    target_total_words: creationVars.total_word_count,\n    use_Search: creationVars.useSearch\n  }\n};\n\n// --- 2. 获取蓝图数组 ---\nconst blueprint = creationVars.blueprint_data || [];\n\nif (blueprint.length === 0) {\n  throw new Error(\"Blueprint data is missing or empty.\");\n}\n\n// --- 3. 物理拆分并注入 DNA ---\nreturn blueprint.map((stage) => {\n  return {\n    json: {\n      p_id: stage.p_id,\n      phase_info: {\n        name: stage.strategy,\n        action: stage.action,\n        guidelines: stage.guidelines,\n        template: stage.pattern_template,\n        target_words: stage.word_count_target,\n        techniques: stage.techniques\n      },\n      global_dna: globalDNA \n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        1936
      ],
      "id": "00c197e5-40d4-4d35-9d6a-ede732b83f2b",
      "name": "global_dna"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        1632,
        1936
      ],
      "id": "e6b54f12-da41-4993-9256-dbc19d7d652f",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=以下是物理缝合后的初稿，请开始执行终审定稿逻辑：\n\n{{ $json.full_article_draft }}",
        "messages": {
          "messageValues": [
            {
              "message": "=# Role\n你是一位{{ $json.global_dna.persona.persona_desc }}。\n你负责对这份分段生成的长篇深度报道进行【最终总编定稿】。\n\n# Global Context\n- 创作主题：{{ $json.global_dna.topic_meta.topic }}\n- 核心关键词：{{ $json.global_dna.lexical.must_use.join('、') }}\n- 叙事审美：{{ $json.global_dna.persona.tone_keywords }}\n- 能量级别：{{ $json.global_dna.persona.energy_level }}\n\n# Final Assembly Mission\n请对输入的初稿执行以下全自动化精修逻辑：\n\n1. **叙事去重与逻辑融合**\n   - 扫描全文，识别并合并由于分段并行生成导致的重复人物背景、相似案例或逻辑循环。\n   - 将重叠的叙事弧线融合成单一且递进的逻辑链条，确保“困境-转折-高光”结构不中断。\n\n2. **语义无缝缝合**\n   - 彻底移除文中所有的 `[SECTION_BREAK]` 标记。\n   - 在衔接处添加符合逻辑的过渡段，确保全文呈现出 {{ $json.global_dna.constraints.rhythm_pattern }} 的流动感。\n\n3. **时效性动态校准**\n   - 当前基准日期为 {{ $json.current_date }}。\n   - 动态处理文中引用的历史年份或数据：通过叙事技巧（如“回望过去两年”、“作为转型初期的基准”）将其融入 2025 年末的当下视角。\n\n4. **度量指标严格执行**\n   - 句法：严控平均句长在 {{ $json.global_dna.constraints.target_sent_len }} 左右。\n   - 规模：严禁删减核心感官细节，必须维持约 {{ $json.global_dna.topic_meta.target_total_words }} 字的总量规模。\n   - 词法：确保关键词自然渗透，严格执行 {{ $json.global_dna.lexical.must_avoid.join('、') }} 的禁用逻辑。\n\n5. **结构重塑与 Markdown 排版 (基于规则)**\n参考规范：{{ $('markdown_rule').item.json.markdown_rule }}\n   - **标题嵌入**：将全文划分为 5-7 个章节，建立二级标题 (##)；并在章节内根据转折点嵌入 2-3 个三级标题 (###)。标题需体现 {{ $json.global_dna.persona.tone_keywords }} 风格，融合意象与洞察（如“数字洪流下的旧罗盘”）。\n   - **视觉分割**：故事与深度分析过渡处必须使用标题或 `---`。\n   - **视觉化决策**：**非必要不图表，一图表即精华**。仅在对比时使用【表格】，描述复杂流向时使用【Mermaid 图表】，灵魂金句或独白使用【引用块 (>)】。\n   - **呼吸感控制**：保持段落短促（符合 {{ $json.global_dna.constraints.target_para_len }}）；关键概念使用 `行内代码`；痛点词汇使用 **加粗**。\n\n# Quality Check\n- 避免排版过于花哨。确保全文即便无图表，仅靠文字分段与引用也能呈现极佳的阅读呼吸感。\n\n# Output Requirement\n请直接输出最终定稿版本，保留 Markdown 格式，禁止包含任何开场白或解释文字。"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.9,
      "position": [
        2080,
        1936
      ],
      "id": "172503fa-23d1-41d1-9f40-00a7aa235805",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "jsCode": "/**\n * n8n 2.2 物理缝合 + 强制源头回溯引用\n */\n\n// 1. 获取 Aggregate 节点传来的 8 段文案\nconst allInput = $input.all();\nconst dataArray = allInput[0].json.data;\n\nif (!dataArray || dataArray.length === 0) {\n  throw new Error(\"Aggregate 节点没有正确输出 data 数组\");\n}\n\n// 2. 物理缝合全文\nconst fullArticle = dataArray.map(item => item.text).join('\\n\\n[SECTION_BREAK]\\n\\n');\n\n// 3. 强制从源头节点获取 global_dna (Back-referencing)\n// 语法说明：$(节点名).first().json.字段名\nlet dna;\ntry {\n  // 这里必须确保你的第一个 Code 节点名称确实叫 \"global_dna\"\n  dna = $(\"global_dna\").first().json.global_dna;\n} catch (e) {\n  throw new Error(\"回溯引用失败：请确认工作流中存在名为 'global_dna' 的节点，且该节点已成功运行。\");\n}\n\n// 4. 输出给下游 LLM 定稿节点\nreturn {\n  full_article_draft: fullArticle,\n  global_dna: dna, \n  current_date: \"2025/12/27\",\n  metadata: {\n    total_sections: dataArray.length,\n    engine_version: \"2.2\"\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1856,
        1936
      ],
      "id": "5849e8a7-f8d2-4f9c-a4df-f13eadbac654",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "588df6b1-d146-41a3-8903-7c7163f98959",
              "name": "markdown_rule",
              "value": "={\n  \"markdown_syntax\": {\n    \"basic\": {\n      \"headings\": {\n        \"description\": \"用 # 号创建标题，数量表示级别\",\n        \"syntax\": [\"# 一级标题\", \"## 二级标题\", \"### 三级标题\", \"#### 四级标题\"]\n      },\n      \"paragraph\": {\n        \"description\": \"段落之间空一行创建新段落\"\n      },\n      \"text_styles\": {\n        \"bold\": { \"syntax\": [\"**文字**\", \"__文字__\"] },\n        \"italic\": { \"syntax\": [\"*文字*\", \"_文字_\"] },\n        \"strikethrough\": { \"syntax\": \"~~文字~~\" },\n        \"highlight\": { \"syntax\": \"==文字==\" },\n        \"underline\": { \"syntax\": \"++文字++\" },\n        \"wavy\": { \"syntax\": \"~文字~\" }\n      },\n      \"lists\": {\n        \"unordered\": { \"syntax\": [\"- 项目\", \"* 项目\", \"+ 项目\"] },\n        \"ordered\": { \"syntax\": \"1. 项目\" },\n        \"nesting\": \"缩进实现嵌套\"\n      },\n      \"links\": {\n        \"syntax\": \"[显示文本](链接地址)\"\n      },\n      \"images\": {\n        \"syntax\": \"![描述文本](图片链接)\",\n        \"slideshow\": \"<![alt](url),![alt](url)>\"\n      },\n      \"blockquote\": {\n        \"syntax\": \"> 引用内容\",\n        \"nested\": \">> 嵌套引用\"\n      },\n      \"code\": {\n        \"inline\": \"`code`\",\n        \"block\": \"```语言\\n代码\\n```\"\n      },\n      \"horizontal_rule\": {\n        \"syntax\": [\"---\", \"***\", \"___\"]\n      },\n      \"table\": {\n        \"syntax\": \"| 列1 | 列2 |\\n| --- | --- |\\n| 数据 | 数据 |\"\n      }\n    },\n    \"advanced\": {\n      \"latex\": {\n        \"inline\": [\"$公式$\", \"\\\\(公式\\\\)\"],\n        \"block\": [\"$$\\n公式\\n$$\", \"\\\\[\\n公式\\n\\\\]\"]\n      },\n      \"mermaid\": {\n        \"syntax\": \"```mermaid\\ngraph LR\\n  A-->B\\n```\",\n        \"types\": [\"flowchart\", \"sequence\", \"pie\"]\n      },\n      \"plantuml\": {\n        \"syntax\": \"```plantuml\\n@startuml\\n...\\n@enduml\\n```\"\n      },\n      \"ruby_annotation\": {\n        \"syntax\": [\"[文字]{注音}\", \"[文字]^(注音)\"],\n        \"separators\": [\"・\", \"．\", \"。\", \"-\"]\n      }\n    }\n  }\n}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -288,
        2224
      ],
      "id": "c2aabfb1-c8f7-4136-b640-807417a8159d",
      "name": "markdown_rule"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "task_executions",
          "mode": "list",
          "cachedResultName": "task_executions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "task_id": "={{ $('Hono Webhook1').item.json.body.taskId }}",
            "status": "completed",
            "input_snapshot": "={{ $('Hono Webhook1').item.json.body }}",
            "article_markdown": "={{ $json.text }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "task_id",
              "displayName": "task_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "n8n_execution_id",
              "displayName": "n8n_execution_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "failed",
                  "value": "failed"
                },
                {
                  "name": "completed",
                  "value": "completed"
                },
                {
                  "name": "running",
                  "value": "running"
                }
              ]
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "input_snapshot",
              "displayName": "input_snapshot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "result",
              "displayName": "result",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "started_at",
              "displayName": "started_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "completed_at",
              "displayName": "completed_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "duration_ms",
              "displayName": "duration_ms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "article_markdown",
              "displayName": "article_markdown",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "article_html",
              "displayName": "article_html",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2432,
        1936
      ],
      "id": "c89a20b6-b41b-4c84-8b49-0eb21b79b56e",
      "name": "Insert rows in a table",
      "credentials": {
        "postgres": {
          "id": "XTSDl3uToEpo9ujr",
          "name": "media-ops"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "tasks",
          "mode": "list",
          "cachedResultName": "tasks"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Hono Webhook1').item.json.body.taskId }}",
            "status": "completed"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "topic",
              "displayName": "topic",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "keywords",
              "displayName": "keywords",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "cancelled",
                  "value": "cancelled"
                },
                {
                  "name": "failed",
                  "value": "failed"
                },
                {
                  "name": "completed",
                  "value": "completed"
                },
                {
                  "name": "processing",
                  "value": "processing"
                },
                {
                  "name": "pending",
                  "value": "pending"
                }
              ]
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "deleted_at",
              "displayName": "deleted_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ref_material_id",
              "displayName": "ref_material_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "cover_prompt_id",
              "displayName": "cover_prompt_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "total_word_count",
              "displayName": "total_word_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2656,
        1936
      ],
      "id": "6509e9cc-0529-4036-9500-fd4b810c7c58",
      "name": "Update rows in a table",
      "credentials": {
        "postgres": {
          "id": "XTSDl3uToEpo9ujr",
          "name": "media-ops"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# 目标文章主题：{{ $('创作变量').item.json.Topic }}\n# 目标文章关键字：{{ $('创作变量').item.json.Keywords }}\n# 网络素材:{{ $json.global_dna.search_material }}\n# 当前阶段任务：[ID: {{ $json.p_id }}] - {{ $json.phase_info.name }}\n- **核心动作**：{{ $json.phase_info.action }}\n- **执行准则**：{{ $json.phase_info.guidelines }}\n- **句式模板**：{{ $json.phase_info.template }}\n- **目标字数**：{{ $json.phase_info.target_words }}\n- **应用技巧**：{{ $json.phase_info.techniques.join('、') }}\n\n# 质量对标 (Golden Sample)\n请参考以下样本的感官描写逻辑，不要生搬硬套，以主题相关的真实信息为基础：\n\"{{ $json.global_dna.golden_sample.paragraph }}\"\n\n# 绝对禁止 (Anti-Pattern)\n{{ $json.global_dna.anti_patterns[0].forbidden }}\n错误示范：{{ $json.global_dna.anti_patterns[0].bad_case }}\n修正建议：{{ $json.global_dna.anti_patterns[0].fix_suggestion }}\n\n# 输出要求\n请直接开始创作本段落的文案内容，无需任何解释。确保将“{{ $json.global_dna.topic_meta.topic }}”这一主题与本阶段的动作完美融合。\n\n# 写作负面清单\n任何意象/概念词（如\"天际线\"\"锻造\"\"赋能\"）全文不超过2次\n禁止在每段重复使用同一组核心词汇的排列组合\n禁止用加粗标记强行植入关键词\n禁止伪深刻句式\n\n禁用\"这不是X，而是Y\"句式，除非紧随其后有具体论证\n禁用\"本质上是……\"\"真正的……在于……\"等抽象升华，除非能用事实支撑\n禁止用更抽象的词替换稍具体的词并称之为\"洞察\"\n禁止华丽空转\n\n禁止连续三句以上无具体信息的抒情/宣言式表达\n禁止以比喻代替论证",
        "messages": {
          "messageValues": [
            {
              "message": "=# 身份与立场\n你是一位{{ $json.global_dna.persona.persona_desc }}。\n你的语调风格：{{ $json.global_dna.persona.tone_keywords }}。\n你的叙事能量：{{ $json.global_dna.persona.energy_level }}。\n\n# 核心语言控制 (红线)\n- 【参考，但不要死板套用】：{{ $json.global_dna.lexical.must_use.join('、') }}\n- 【形容词风格】：{{ $json.global_dna.lexical.adj_style }}\n- 【动词偏好】：{{ $json.global_dna.lexical.verb_style }}\n- 【严禁词汇】：{{ $json.global_dna.lexical.must_avoid.join('、') }}\n\n# 文本律动\n- 节奏模型：{{ $json.global_dna.constraints.rhythm_pattern }}\n- 目标句长：{{ $json.global_dna.constraints.target_sent_len }}\n- 段落标准：{{ $json.global_dna.constraints.target_para_len }}"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.8,
      "position": [
        1280,
        1936
      ],
      "id": "63a4dbb8-4d0d-465a-91b7-bf099b60246a",
      "name": "基于大语言模型的写作",
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "fef46521-8433-4c2b-8bd3-f4f27c7ffe22",
              "leftValue": "={{ $json.useSearch }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        160,
        1936
      ],
      "id": "41c8e415-ea78-4fa0-b7ed-91f80237227f",
      "name": "If"
    },
    {
      "parameters": {
        "messages": {
          "message": [
            {
              "content": "你是一个专业的资料收集助手，请根据主题搜集最新的深度素材、数据和真实案例。",
              "role": "system"
            },
            {
              "content": "=请针对主题：'{{ $json.Topic }}' 和 关键字：'{{ $json.Keywords }}' 进行深度网络搜索，提供5条具体的背景素材或最新社会现象。"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.perplexity",
      "typeVersion": 1,
      "position": [
        384,
        1840
      ],
      "id": "4232f220-3937-48e8-802b-b61f890684e3",
      "name": "Message a model",
      "credentials": {
        "perplexityApi": {
          "id": "5ESUHCDkK9ztpaAP",
          "name": "Perplexity account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5069f6e9-aaf0-4716-b75c-02dca1cb5af8",
              "name": "search_material",
              "value": "={{ $json.search_results }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        608,
        1840
      ],
      "id": "5ef9f3a6-77a8-4462-a4f1-a487fc995e10",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3a642dfb-65af-459d-9f29-bc432cb1a877",
              "name": "search_material",
              "value": "无外部搜索素材",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        608,
        2032
      ],
      "id": "a5f79563-3ed9-409a-b6cd-9719b0229239",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1352,
        2160
      ],
      "id": "a7419f31-d6f0-42fe-8f58-33fb61226c13",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "gbk9ly5Ad03ln6Yc",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        1056,
        1936
      ],
      "id": "75280f71-7981-4895-a208-dfe0687bacfe",
      "name": "Aggregate1"
    }
  ],
  "connections": {
    "Hono Webhook1": {
      "main": [
        [
          {
            "node": "封面图要求1",
            "type": "main",
            "index": 0
          },
          {
            "node": "创作主题1",
            "type": "main",
            "index": 0
          },
          {
            "node": "创作风格要求1",
            "type": "main",
            "index": 0
          },
          {
            "node": "markdown_rule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "创作主题1": {
      "main": [
        [
          {
            "node": "创作变量",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "创作风格要求1": {
      "main": [
        [
          {
            "node": "创作变量",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "封面图要求1": {
      "main": [
        [
          {
            "node": "创作变量",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "创作变量": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "global_dna": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Insert rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "markdown_rule": {
      "main": [
        [
          {
            "node": "创作变量",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Insert rows in a table": {
      "main": [
        [
          {
            "node": "Update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "基于大语言模型的写作": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "global_dna",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "global_dna",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "基于大语言模型的写作",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "基于大语言模型的写作",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b567d3c8d87fb7f8b70a1dd36ea2ab492a07686b7429a62e28beb58f3b19cc21"
  }
}}