"use client"

import {
    createContext,
    useCallback,
    useContext,
    useEffect,
    useMemo,
    useState,
} from "react"
import enMessages from "@/locales/en.json"
import zhCNMessages from "@/locales/zh-CN.json"

export type Locale = "en" | "zh-CN"

export type I18nKey =
    // Common
    | "common.loading"
    | "common.save"
    | "common.cancel"
    | "common.delete"
    | "common.edit"
    | "common.create"
    | "common.update"
    | "common.confirm"
    | "common.selected"
    | "common.expand"
    | "common.collapse"
    | "common.search"
    | "common.noData"
    | "common.date"
    | "common.enabled"
    | "common.disabled"
    | "common.saved"
    | "common.copy"
    | "common.copied"
    // Auth
    | "auth.login"
    | "auth.logout"
    | "auth.username"
    | "auth.accessCode"
    | "auth.loginButton"
    | "auth.loggingIn"
    | "auth.invalidCredentials"
    | "auth.required"
    | "auth.signInWithGoogle"
    | "auth.signInWithGitHub"
    | "auth.signIn"
    | "auth.usernamePlaceholder"
    | "auth.accessCodePlaceholder"
    | "auth.orContinueWith"
    | "auth.usernameRequired"
    | "auth.accessCodeRequired"
    | "auth.accountDisabled"
    | "profile.title"
    | "profile.profileTitle"
    | "profile.displayName"
    | "profile.displayNamePlaceholder"
    | "profile.nameRequired"
    | "profile.passwordTitle"
    | "profile.currentPassword"
    | "profile.currentPasswordPlaceholder"
    | "profile.newPassword"
    | "profile.newPasswordPlaceholder"
    | "profile.confirmPassword"
    | "profile.confirmPasswordPlaceholder"
    | "profile.updatePassword"
    | "profile.passwordMismatch"
    | "profile.profileUpdated"
    | "profile.passwordUpdated"
    | "profile.tabProfile"
    | "profile.tabPassword"
    | "profile.tabStorage"
    // Storage Config
    | "profile.storageTitle"
    | "profile.storageProvider"
    | "profile.storageBucket"
    | "profile.storageAccessKey"
    | "profile.storageSecretKey"
    | "profile.storagePublicDomain"
    | "profile.storageR2AccountId"
    | "profile.storageS3Region"
    | "profile.storageS3Endpoint"
    | "profile.storageConfigName"
    | "profile.storageLocal"
    | "profile.storageR2"
    | "profile.storageS3"
    | "profile.storageTest"
    | "profile.storageTestSuccess"
    | "profile.storageTestFailed"
    | "profile.storageSaved"
    | "profile.storageActive"
    | "profile.storageInactive"
    | "profile.storageActivate"
    | "profile.storageDeactivate"
    // Navigation
    | "nav.dashboard"
    | "nav.pipeline"
    | "nav.prompts"
    | "nav.tasks"
    | "nav.articles"
    | "nav.wechatArticles"
    | "nav.settings"
    | "nav.xhsImages"
    | "nav.analytics"
    | "nav.materials"
    | "nav.imagePromptAnalytics"
    | "nav.taskAnalytics"
    | "nav.xhsAnalytics"
    | "nav.wechatArticleAnalytics"
    | "nav.pipelineAnalytics"
    | "nav.embeddingAnalytics"
    | "nav.insights"
    | "nav.reverse"
    | "nav.creationGroup"
    | "nav.materialsGroup"
    // Tasks
    | "tasks.title"
    | "tasks.newTask"
    | "tasks.noTasks"
    | "tasks.created"
    | "tasks.untitledTask"
    | "tasks.noKeywords"
    | "tasks.polling"
    | "tasks.refMaterial"
    | "tasks.searchPlaceholder"
    | "tasks.noSearchResults"
    | "tasks.tryDifferentKeywords"
    | "tasks.clearSearch"
    | "tasks.writingProgress"
    | "tasks.polishing"
    // Task Status
    | "status.pending"
    | "status.processing"
    | "status.completed"
    | "status.failed"
    | "status.cancelled"
    // Task Actions
    | "task.retry"
    | "task.stop"
    | "task.deleteConfirm"
    | "task.retryConfirm"
    | "task.stopConfirm"
    | "task.updateFailed"
    // Task Form
    | "taskForm.title"
    | "taskForm.regenerateTitle"
    | "taskForm.articleTab"
    | "taskForm.coverTab"
    | "taskForm.topic"
    | "taskForm.topicPlaceholder"
    | "taskForm.keywords"
    | "taskForm.keywordsPlaceholder"
    | "taskForm.totalWordCount"
    | "taskForm.style"
    | "taskForm.stylePlaceholder"
    | "taskForm.openingExample"
    | "taskForm.openingExamplePlaceholder"
    | "taskForm.structureGuide"
    | "taskForm.structureGuidePlaceholder"
    | "taskForm.outputSchema"
    | "taskForm.outputSchemaPlaceholder"
    | "taskForm.coverPrompt"
    | "taskForm.coverPromptPlaceholder"
    | "taskForm.coverRatio"
    | "taskForm.coverResolution"
    | "taskForm.coverModel"
    | "taskForm.coverMode"
    | "taskForm.coverNegativePrompt"
    | "taskForm.coverNegativePromptPlaceholder"
    | "taskForm.submit"
    | "taskForm.submitting"
    | "taskForm.ratio16_9"
    | "taskForm.ratio1_1"
    | "taskForm.ratio4_3"
    | "taskForm.ratio3_4"
    | "taskForm.ratio9_16"
    | "taskForm.ratio21_9"
    | "taskForm.resolution1k"
    | "taskForm.resolution2k"
    | "taskForm.resolution4k"
    | "taskForm.modeText2img"
    | "taskForm.modeSingleImg2img"
    | "taskForm.modeMultiImg2img"
    | "taskForm.useSearch"
    // Wizard steps
    | "taskForm.step1Title"
    | "taskForm.step2Title"
    | "taskForm.step2Desc"
    | "taskForm.step3Title"
    | "taskForm.selectCoverPrompt"
    | "taskForm.coverStylePrompt"
    | "taskForm.coverStylePromptPlaceholder"
    | "taskForm.noMaterials"
    | "taskForm.prev"
    | "taskForm.next"
    // Prompts
    | "prompts.title"
    | "prompts.createPrompt"
    | "prompts.editPrompt"
    | "prompts.name"
    | "prompts.content"
    | "prompts.category"
    | "prompts.description"
    | "prompts.noPrompts"
    | "prompts.deleteConfirm"
    // Image Prompts
    | "imagePrompts.title"
    | "imagePrompts.createTitle"
    | "imagePrompts.editTitle"
    | "imagePrompts.titleLabel"
    | "imagePrompts.titlePlaceholder"
    | "imagePrompts.promptLabel"
    | "imagePrompts.promptPlaceholder"
    | "imagePrompts.negativePromptLabel"
    | "imagePrompts.negativePromptPlaceholder"
    | "imagePrompts.modelLabel"
    | "imagePrompts.ratioLabel"
    | "imagePrompts.resolutionLabel"
    | "imagePrompts.categoryLabel"
    | "imagePrompts.tagsLabel"
    | "imagePrompts.tagsPlaceholder"
    | "imagePrompts.publicLabel"
    | "imagePrompts.publicDescription"
    | "imagePrompts.searchPlaceholder"
    | "imagePrompts.allCategories"
    | "imagePrompts.noPrompts"
    | "imagePrompts.totalRecords"
    | "imagePrompts.prevPage"
    | "imagePrompts.nextPage"
    | "imagePrompts.duplicate"
    | "imagePrompts.copyPrompt"
    | "imagePrompts.makePrivate"
    | "imagePrompts.makePublic"
    | "imagePrompts.usageCount"
    | "imagePrompts.deleteConfirm"
    | "imagePrompts.duplicateSuffix"
    // Image Prompt Options
    | "imagePrompts.model.jimeng45"
    | "imagePrompts.model.jimeng40"
    | "imagePrompts.model.jimeng31"
    | "imagePrompts.model.nanobanana"
    | "imagePrompts.ratio.square"
    | "imagePrompts.ratio.landscape"
    | "imagePrompts.ratio.portrait"
    | "imagePrompts.ratio.4_3"
    | "imagePrompts.ratio.3_4"
    | "imagePrompts.ratio.ultrawide"
    | "imagePrompts.resolution.1k"
    | "imagePrompts.resolution.2k"
    | "imagePrompts.resolution.4k"
    | "imagePrompts.category.general"
    | "imagePrompts.category.cover"
    | "imagePrompts.category.portrait"
    | "imagePrompts.category.landscape"
    | "imagePrompts.category.product"
    | "imagePrompts.category.abstract"
    // Settings
    | "settings.title"
    | "settings.appearance"
    | "settings.theme"
    | "settings.language"
    | "settings.light"
    | "settings.dark"
    | "settings.auto"
    | "settings.defaultTheme"
    // Insights
    | "nav.insights"
    | "insights.title"
    | "insights.styleProfile"
    | "insights.noProfile"
    | "insights.totalAnalyses"
    | "insights.successRate"
    | "insights.topGenres"
    | "insights.averageMetrics"
    | "insights.metrics"
    | "insights.burstiness"
    | "insights.ttr"
    | "insights.avgSentLen"
    | "insights.avgParaLen"
    | "insights.wordCount"
    | "insights.toneKeywords"
    | "insights.commonVocabulary"
    | "insights.lastAnalysis"
    | "insights.metricsTrend"
    | "insights.days"
    | "insights.genreInsights"
    | "insights.selectGenre"
    | "insights.promptSuggestions"
    | "insights.topPrompts"
    | "insights.qualityScore"
    | "insights.viewPrompt"
    | "insights.statistics"
    | "insights.byStatus"
    | "insights.byGenre"
    | "insights.topCategories"
    | "insights.selectCategory"
    | "insights.categoryInsights"
    | "insights.byCategory"
    | "insights.byStyleName"
    | "insights.byTextType"
    | "insights.ttrDescription"
    | "insights.burstyDescription"
    // Reverse
    | "nav.reverse"
    | "reverse.title"
    | "reverse.description"
    | "reverse.inputType"
    | "reverse.typeUrl"
    | "reverse.typeText"
    | "reverse.urlPlaceholder"
    | "reverse.textPlaceholder"
    | "reverse.contentPlaceholder"
    | "reverse.submit"
    | "reverse.submitting"
    | "reverse.submitSuccess"
    | "reverse.submitError"
    | "reverse.urlRequired"
    | "reverse.textRequired"
    | "reverse.invalidUrl"
    | "reverse.newAnalysis"
    | "reverse.noRecords"
    | "reverse.searchPlaceholder"
    | "reverse.noSearchResults"
    | "reverse.tryDifferentKeywords"
    | "reverse.clearSearch"
    | "reverse.articleTitle"
    | "reverse.articleUrl"
    | "reverse.readOriginal"
    | "reverse.genre"
    | "reverse.status"
    | "reverse.createdAt"
    | "reverse.viewPrompt"
    | "reverse.statusSuccess"
    | "reverse.statusFailed"
    | "reverse.statusPending"
    | "reverse.untitled"
    | "reverse.detail"
    | "reverse.originalContent"
    | "reverse.reverseResult"
    | "reverse.tone"
    | "reverse.structure"
    | "reverse.vocabulary"
    | "reverse.metrics"
    | "reverse.modelName"
    | "reverse.totalTokens"
    | "reverse.cost"
    | "reverse.executionId"
    | "reverse.noContent"
    | "reverse.deleteConfirm"
    | "reverse.tabStyle"
    | "reverse.tabPrompt"
    | "reverse.tabBlueprint"
    | "reverse.tabMetrics"
    | "reverse.styleName"
    | "reverse.archetype"
    | "reverse.targetAudience"
    | "reverse.toneKeywords"
    | "reverse.clickToViewFull"
    | "reverse.totalWords"
    | "reverse.metaProfile"
    | "reverse.personaDescription"
    | "reverse.voiceTraits"
    | "reverse.voiceFormality"
    | "reverse.voiceEnergy"
    | "reverse.voiceWarmth"
    | "reverse.voiceConfidence"
    | "reverse.sentenceCount"
    | "reverse.paragraphCount"
    | "reverse.analysisConfidence"
    | "reverse.styleStability"
    | "reverse.styleConsistency"
    | "reverse.coreRulesCount"
    | "reverse.topRuleFeature"
    | "reverse.tabVoice"
    | "reverse.tabCoreRules"
    | "reverse.sentenceTemplates"
    | "reverse.antiPatterns"
    | "reverse.secondaryTraits"
    | "reverse.textTypeRationale"
    | "reverse.tabGoldenSamples"
    | "reverse.tabTransferDemo"
    | "reverse.tabLexicalRhetoric"
    | "reverse.tabExecutionPrompt"
    | "reverse.goldenSample"
    | "reverse.sampleText"
    | "reverse.sampleReason"
    | "reverse.transferBefore"
    | "reverse.transferAfter"
    | "reverse.transferExplanation"
    | "reverse.vocabularyTier"
    | "reverse.preferredTerms"
    | "reverse.bannedTerms"
    | "reverse.preferredDevices"
    | "reverse.deviceFrequency"
    | "reverse.executionPrompt"
    | "reverse.analysisVersion"
    | "reverse.noSamples"
    | "reverse.noTransferDemo"
    | "reverse.tabRules"
    | "reverse.tabSamples"
    | "reverse.coreRulesSection"
    | "reverse.lexicalSection"
    | "reverse.rhetoricSection"
    | "reverse.antiPatternsSection"
    | "reverse.goldenSamplesSection"
    | "reverse.transferDemoSection"
    | "reverse.executionPromptLabel"
    | "reverse.deleteSuccess"
    | "reverse.deleteFailed"
    | "reverse.copySuccess"
    | "reverse.copyFailed"
    | "reverse.noPromptToCopy"
    | "reverse.cloneToTask"
    | "reverse.colTitle"
    | "reverse.colType"
    | "reverse.colArchetype"
    | "reverse.colWordCount"
    | "reverse.colTtr"
    | "reverse.colUpdated"
    | "reverse.colActions"
    | "reverse.useCount"
    | "reverse.noLogs"
    // App
    | "app.title"
    | "app.description"
    // Article viewer
    | "article.preview"
    | "article.source"
    | "article.copyMarkdown"
    | "article.copied"
    | "article.viewArticle"
    | "common.close"
    // Articles page
    | "articles.title"
    | "articles.subtitle"
    | "articles.searchPlaceholder"
    | "articles.loadError"
    | "articles.noArticles"
    | "articles.noSearchResults"
    | "articles.tryDifferentKeywords"
    | "articles.moreContentComing"
    | "articles.clearSearch"
    | "articles.noCover"
    | "articles.readingTime"
    | "articles.lessThanOneMinute"
    | "articles.prevPage"
    | "articles.nextPage"
    | "articles.readMore"
    | "articles.backToList"
    | "articles.loadingArticle"
    | "articles.articleNotFound"
    | "articles.loginBackend"
    | "articles.aboutMinutes"
    | "articles.wordCount"
    | "articles.unknownWordCount"
    // Create Hub
    | "createHub.title"
    | "createHub.whatToDo"
    | "createHub.importMaterial"
    | "createHub.importMaterialDesc"
    | "createHub.startWriting"
    | "createHub.startWritingDesc"
    | "createHub.recentMaterials"
    | "createHub.noRecentMaterials"
    | "createHub.importSuccess"
    | "createHub.useThisMaterial"
    | "createHub.continueImport"
    // XHS Images
    | "xhsImages.title"
    | "xhsImages.noJobs"
    | "xhsImages.created"
    | "xhsImages.completed"
    | "xhsImages.imageCount"
    | "xhsImages.progress"
    | "xhsImages.viewImages"
    | "xhsImages.deleteConfirm"
    | "xhsImages.noImages"
    | "xhsImages.downloadAll"
    | "xhsImages.copyUrl"
    | "xhsImages.urlCopied"
    | "xhsImages.filterLabel"
    | "xhsImages.filterAll"
    | "xhsImages.coverImage"
    | "xhsImages.contentImage"
    | "xhsImages.endingImage"
    | "xhsImages.sourceTitle"
    | "xhsImages.sourceUrl"
    | "xhsImages.generate"
    | "xhsImages.generateTitle"
    | "xhsImages.inputContent"
    | "xhsImages.inputContentPlaceholder"
    | "xhsImages.selectStyle"
    | "xhsImages.moreStyles"
    | "xhsImages.generating"
    | "xhsImages.generateSuccess"
    | "xhsImages.generateFailed"
    | "xhsImages.noPromptsAvailable"
    | "xhsImages.publish"
    | "xhsImages.publishing"
    | "xhsImages.publishSuccess"
    | "xhsImages.publishFailed"
    | "xhsImages.cancel"
    | "xhsImages.cancelling"
    | "xhsImages.cancelConfirm"
    | "xhsImages.cancelSuccess"
    | "xhsImages.cancelFailed"
    | "xhsImages.retry"
    | "xhsImages.retrying"
    | "xhsImages.retrySuccess"
    | "xhsImages.retryFailed"
    | "createHub.generateXhsImages"
    | "createHub.generateXhsImagesDesc"
    | "wechatArticles.title"
    | "wechatArticles.subtitle"
    | "wechatArticles.searchPlaceholder"
    | "wechatArticles.noArticles"
    | "wechatArticles.prevPage"
    | "wechatArticles.nextPage"
    | "wechatArticles.viewOriginal"
    | "wechatArticles.author"
    | "wechatArticles.publishTime"
    | "wechatArticles.accountName"
    | "wechatArticles.fakeid"

interface I18nContextValue {
    locale: Locale
    setLocale: (locale: Locale) => void
    t: (key: I18nKey, vars?: Record<string, string | number>) => string
}

const I18nContext = createContext<I18nContextValue | null>(null)

const STORAGE_KEY = "media-ops-locale"

// Import translations from JSON files
const MESSAGES: Record<Locale, Record<I18nKey, string>> = {
    en: enMessages as Record<I18nKey, string>,
    "zh-CN": zhCNMessages as Record<I18nKey, string>,
}

function formatMessage(
    template: string,
    vars?: Record<string, string | number>
): string {
    if (!vars) return template
    return template.replace(/\{(\w+)\}/g, (_, key) => {
        return vars[key]?.toString() ?? `{${key}}`
    })
}

function detectLocale(): Locale {
    if (typeof window === "undefined") return "zh-CN"

    const stored = localStorage.getItem(STORAGE_KEY)
    if (stored === "en" || stored === "zh-CN") return stored

    const browserLang = navigator.language
    if (browserLang.startsWith("zh")) return "zh-CN"
    return "en"
}

interface I18nProviderProps {
    children: React.ReactNode
    defaultLocale?: Locale
}

export function I18nProvider({
    children,
    defaultLocale = "zh-CN",
}: I18nProviderProps) {
    const [locale, setLocaleState] = useState<Locale>(defaultLocale)

    useEffect(() => {
        const detected = detectLocale()
        setLocaleState(detected)
    }, [])

    useEffect(() => {
        if (typeof window === "undefined") return
        document.documentElement.lang = locale
    }, [locale])

    const setLocale = useCallback((newLocale: Locale) => {
        setLocaleState(newLocale)
        try {
            localStorage.setItem(STORAGE_KEY, newLocale)
        } catch (error) {
            console.warn("[I18nProvider] Failed to persist locale", error)
        }
    }, [])

    const t = useCallback(
        (key: I18nKey, vars?: Record<string, string | number>): string => {
            const messages = MESSAGES[locale]
            const template = messages[key] ?? MESSAGES.en[key] ?? key
            return formatMessage(template, vars)
        },
        [locale]
    )

    const value = useMemo<I18nContextValue>(
        () => ({ locale, setLocale, t }),
        [locale, setLocale, t]
    )

    return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
}

export function useI18n() {
    const context = useContext(I18nContext)
    if (!context) {
        throw new Error("useI18n must be used within an I18nProvider")
    }
    return context
}
