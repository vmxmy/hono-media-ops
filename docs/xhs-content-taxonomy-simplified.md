# å°çº¢ä¹¦å†…å®¹åˆ†ç±»ä½“ç³»è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰

## æ¦‚è¿°

è®¾è®¡å°çº¢ä¹¦å†…å®¹çš„åˆ†ç±»ä½“ç³»ï¼š**èµ›é“ï¼ˆTrackï¼‰â†’ ç±»å‹ï¼ˆCategoryï¼‰â†’ å…ƒå±æ€§ï¼ˆMetaï¼‰**ã€‚

è§†è§‰é£æ ¼å’Œæ–‡æ¡ˆé£æ ¼ç”±ç³»ç»Ÿä¸­ç°æœ‰çš„ `image_prompts` å’Œ `style_analyses` è¡¨ç®¡ç†ã€‚

---

## 1. èµ›é“ï¼ˆTrackï¼‰- ä¸€çº§åˆ†ç±»

| èµ›é“ä»£ç  | èµ›é“åç§° | æè¿° | å…¸å‹å—ä¼— |
|---------|---------|------|---------|
| `lifestyle` | ç”Ÿæ´»æ–¹å¼ | ç¾é£Ÿã€å’–å•¡ã€æ¢åº—ã€home decor | éƒ½å¸‚ç™½é¢†ã€ç²¾è‡´ç”Ÿæ´»è¿½æ±‚è€… |
| `beauty` | ç¾å¦†ä¸ªæŠ¤ | æŠ¤è‚¤ã€å½©å¦†ã€å‘å‹ã€é¦™æ°´ | å¥³æ€§ä¸ºä¸»ï¼Œ18-35å² |
| `fashion` | æ—¶å°šç©¿æ­ | æœè£…ã€é…é¥°ã€ç©¿æ­æ•™ç¨‹ | æ—¶å°šæ•æ„Ÿäººç¾¤ |
| `travel` | æ—…è¡Œå‡ºæ¸¸ | ç›®çš„åœ°æ”»ç•¥ã€é…’åº—æ°‘å®¿ã€æ™¯ç‚¹ | æ—…æ¸¸çˆ±å¥½è€… |
| `food` | ç¾é£Ÿçƒ¹é¥ª | é£Ÿè°±ã€çƒ˜ç„™ã€é¤å…æ¨è | ç¾é£Ÿçˆ±å¥½è€… |
| `home` | å®¶å±…å®¶è£… | è£…ä¿®ã€æ”¶çº³ã€å®¶ç”µã€è½¯è£… | æœ‰æˆ¿ä¸€æ—ã€æ–°å©šå¤«å¦‡ |
| `parenting` | æ¯å©´è‚²å„¿ | å­•æœŸã€è‚²å„¿ã€æ—©æ•™ã€ç©å…· | å‡†å¦ˆå¦ˆã€0-6å²çˆ¶æ¯ |
| `fitness` | å¥èº«è¿åŠ¨ | å¥èº«ã€ç‘œä¼½ã€è·‘æ­¥ã€å‡è„‚ | å¥èº«çˆ±å¥½è€… |
| `education` | çŸ¥è¯†å­¦ä¹  | æŠ€èƒ½ã€è€ƒè¯ã€è¯­è¨€ã€è¯»ä¹¦ | å­¦ç”Ÿã€èŒåœºäºº |
| `tech` | æ•°ç ç§‘æŠ€ | æ‰‹æœºã€ç”µè„‘ã€æ™ºèƒ½å®¶å±… | ç§‘æŠ€çˆ±å¥½è€… |
| `pets` | èŒå®  | å…»å® ã€å® ç‰©ç”¨å“ã€è®­ç»ƒ | å® ç‰©ä¸»äºº |
| `finance` | ç†è´¢æŠ•èµ„ | ç†è´¢ã€åŸºé‡‘ã€ä¿é™©ã€çœé’± | ç†è´¢æ„è¯†äººç¾¤ |

---

## 2. å†…å®¹ç±»å‹ï¼ˆCategoryï¼‰- äºŒçº§åˆ†ç±»

| ç±»å‹ä»£ç  | ç±»å‹åç§° | æè¿° | é€‚ç”¨èµ›é“ | ç‰¹ç‚¹ |
|---------|---------|------|---------|------|
| `explore` | æ¢åº—/æ¢è®¿ | å®åœ°æ¢è®¿ã€ä½“éªŒåˆ†äº« | lifestyle, food, travel | å¼ºåœºæ™¯ã€é‡æ°›å›´ |
| `review` | æµ‹è¯„/è¯„æµ‹ | äº§å“æ¨ªè¯„ã€æ·±åº¦æµ‹è¯• | beauty, tech, home | æ•°æ®è¯¦å®ã€å¯¹æ¯”æ¸…æ™° |
| `tutorial` | æ•™ç¨‹/æ”»ç•¥ | æ­¥éª¤æ•™å­¦ã€æ“ä½œæŒ‡å— | beauty, food, education | ç»“æ„åŒ–ã€å¯å¤åˆ¶ |
| `knowledge` | å¹²è´§ç§‘æ™® | çŸ¥è¯†åˆ†äº«ã€åŸç†è§£æ | education, finance, fitness | ä¿¡æ¯å¯†åº¦é«˜ |
| `recommendation` | ç§è‰æ¨è | å¥½ç‰©åˆ†äº«ã€æ¸…å•æ¨è | å…¨èµ›é“é€šç”¨ | å¼ºè½¬åŒ–ã€å¸¦è´§å±æ€§ |
| `vlog` | ç”Ÿæ´»è®°å½• | æ—¥å¸¸vlogã€éšæ‰‹æ‹ | lifestyle, travel, pets | çœŸå®ã€è½»æ¾ |
| `comparison` | å¯¹æ¯”é€‰è´­ | A vs Bã€é€‰è´­æŒ‡å— | beauty, tech, home | å†³ç­–è¾…åŠ© |
| `collection` | åˆé›†/æ¦œå• | Top Nã€ç›˜ç‚¹ | å…¨èµ›é“é€šç”¨ | ä¿¡æ¯æ•´åˆ |
| `diy` | DIY/æ‰‹å·¥ | æ‰‹ä½œã€æ”¹é€ ã€åˆ›æ„ | home, food, fashion | åˆ›æ„ã€åŠ¨æ‰‹ |
| `case_study` | æ¡ˆä¾‹åˆ†äº« | æˆåŠŸæ¡ˆä¾‹ã€æ”¹é€ å‰å | home, fashion, fitness | è§†è§‰å†²å‡» |

---

## 3. å…ƒå±æ€§ï¼ˆMeta Attributesï¼‰

æ ¹æ®ä¸åŒå†…å®¹ç±»å‹ï¼Œå®šä¹‰ä¸“å±çš„ç»“æ„åŒ–å±æ€§ã€‚

### 3.1 æ¢åº—ç±»ï¼ˆexploreï¼‰

```typescript
interface ExploreMetaAttributes {
  shop_name: string;              // åº—é“ºåç§°
  shop_type?: string;             // åº—é“ºç±»å‹ï¼šå’–å•¡é¦†ã€é¤å…ã€ä¹¦åº—ç­‰
  address?: string;               // è¯¦ç»†åœ°å€
  city?: string;                  // åŸå¸‚
  district?: string;              // åŒºåŸŸ
  opening_date?: string;          // å¼€ä¸šæ—¶é—´
  price_range?: string;           // äººå‡æ¶ˆè´¹ï¼š30-60ã€100-200ç­‰
  must_try?: string[];            // å¿…ç‚¹æ¨è
  business_hours?: string;        // è¥ä¸šæ—¶é—´
  best_time?: string;             // æœ€ä½³åˆ°åº—æ—¶é—´
  transportation?: string;        // äº¤é€šæ–¹å¼
  reservation_required?: boolean; // æ˜¯å¦éœ€é¢„çº¦
  pet_friendly?: boolean;         // å® ç‰©å‹å¥½
  parking_available?: boolean;    // åœè½¦ä½
  wifi_available?: boolean;       // Wi-Fi
  phone?: string;                 // è”ç³»ç”µè¯
  features?: string[];            // ç‰¹è‰²æ ‡ç­¾ï¼šæ‹ç…§ã€çº¦ä¼šã€å·¥ä½œç­‰
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "shop_name": "ç¬é—´ Slack",
  "shop_type": "å’–å•¡é¦†",
  "address": "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
  "city": "æ·±åœ³",
  "district": "é¾™ååŒº",
  "opening_date": "2024-09",
  "price_range": "30-60",
  "must_try": ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´", "æ©™æ±ä¸€å¤"],
  "business_hours": "10:00-22:00",
  "best_time": "ä¸‹åˆèŒ¶æ—¶æ®µ",
  "reservation_required": false,
  "pet_friendly": true,
  "parking_available": false,
  "wifi_available": true,
  "features": ["éŸ©ç³»", "é©¬å¡é¾™", "æ‹ç…§", "æ–°åº—"]
}
```

### 3.2 æµ‹è¯„ç±»ï¼ˆreviewï¼‰

```typescript
interface ReviewMetaAttributes {
  product_name: string;           // äº§å“åç§°
  brand?: string;                 // å“ç‰Œ
  price?: number;                 // ä»·æ ¼
  capacity?: string;              // å®¹é‡/è§„æ ¼
  rating?: number;                // è¯„åˆ†ï¼ˆ1-5ï¼‰
  pros?: string[];                // ä¼˜ç‚¹
  cons?: string[];                // ç¼ºç‚¹
  suitable_for?: string[];        // é€‚åˆäººç¾¤ï¼šå¹²çš®ã€æ²¹çš®ç­‰
  usage_duration?: string;        // ä½¿ç”¨å‘¨æœŸ
  repurchase?: boolean;           // æ˜¯å¦å›è´­
  alternatives?: string[];        // æ›¿ä»£å“æ¨è
  purchase_channel?: string;      // è´­ä¹°æ¸ é“
  ingredients?: string[];         // æˆåˆ†ï¼ˆç¾å¦†ç±»ï¼‰
  specifications?: Record<string, string>; // è§„æ ¼å‚æ•°ï¼ˆç§‘æŠ€ç±»ï¼‰
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "product_name": "é›…è¯—å…°é»›å°æ£•ç“¶",
  "brand": "EstÃ©e Lauder",
  "price": 780,
  "capacity": "50ml",
  "rating": 4.5,
  "pros": ["å¸æ”¶å¿«", "æäº®", "ä¿®æŠ¤"],
  "cons": ["ä»·æ ¼è´µ", "é¦™å‘³é‡"],
  "suitable_for": ["å¹²çš®", "æ··åˆçš®"],
  "usage_duration": "30å¤©",
  "repurchase": true,
  "alternatives": ["å…°è”»å°é»‘ç“¶", "SK-IIç¥ä»™æ°´"],
  "purchase_channel": "ä¸“æŸœ",
  "ingredients": ["äºŒè£‚é…µæ¯", "é€æ˜è´¨é…¸"]
}
```

### 3.3 æ•™ç¨‹ç±»ï¼ˆtutorialï¼‰

```typescript
interface TutorialMetaAttributes {
  title: string;                  // æ•™ç¨‹æ ‡é¢˜
  difficulty?: 'easy' | 'medium' | 'hard'; // éš¾åº¦
  time_required?: string;         // æ‰€éœ€æ—¶é—´
  steps?: number;                 // æ­¥éª¤æ•°
  materials_needed?: string[];    // æ‰€éœ€ææ–™/å·¥å…·
  suitable_for?: string[];        // é€‚åˆäººç¾¤
  occasion?: string[];            // é€‚ç”¨åœºæ™¯
  season?: string[];              // é€‚ç”¨å­£èŠ‚
  skills_learned?: string[];      // å­¦åˆ°çš„æŠ€èƒ½
  video_duration?: string;        // è§†é¢‘æ—¶é•¿ï¼ˆå¦‚æœ‰ï¼‰
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "title": "æ—¥å¸¸é€šå‹¤å¦†æ•™ç¨‹",
  "difficulty": "easy",
  "time_required": "15åˆ†é’Ÿ",
  "steps": 7,
  "materials_needed": ["ç²‰åº•æ¶²", "çœ¼å½±ç›˜", "å£çº¢"],
  "suitable_for": ["æ–°æ‰‹", "å­¦ç”Ÿå…š"],
  "occasion": ["ä¸Šç­", "çº¦ä¼š", "æ—¥å¸¸"],
  "season": ["å››å­£é€šç”¨"],
  "skills_learned": ["åº•å¦†æŠ€å·§", "çœ¼å¦†å åŠ "]
}
```

### 3.4 å¹²è´§ç§‘æ™®ç±»ï¼ˆknowledgeï¼‰

```typescript
interface KnowledgeMetaAttributes {
  topic: string;                  // ä¸»é¢˜
  knowledge_depth?: 'beginner' | 'intermediate' | 'advanced'; // æ·±åº¦
  reading_time?: string;          // é˜…è¯»æ—¶é•¿
  key_points?: string[];          // æ ¸å¿ƒè¦ç‚¹
  references?: string[];          // å‚è€ƒèµ„æ–™
  target_audience?: string[];     // ç›®æ ‡å—ä¼—
  myths_busted?: string[];        // è¾Ÿè°£å†…å®¹
  actionable_tips?: string[];     // å¯æ‰§è¡Œå»ºè®®
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "topic": "HIITè®­ç»ƒåŸç†",
  "knowledge_depth": "intermediate",
  "reading_time": "5åˆ†é’Ÿ",
  "key_points": ["ä»€ä¹ˆæ˜¯HIIT", "ç‡ƒè„‚åŸç†", "è®­ç»ƒæ–¹æ¡ˆ"],
  "target_audience": ["å¥èº«çˆ±å¥½è€…", "å‡è„‚äººç¾¤"],
  "myths_busted": ["HIITä¸é€‚åˆæ–°æ‰‹ï¼ˆé”™ï¼‰"],
  "actionable_tips": ["æ¯å‘¨3æ¬¡", "æ§åˆ¶å¿ƒç‡", "æ³¨æ„æ‹‰ä¼¸"]
}
```

### 3.5 ç§è‰æ¨èç±»ï¼ˆrecommendationï¼‰

```typescript
interface RecommendationMetaAttributes {
  list_title?: string;            // æ¸…å•æ ‡é¢˜
  item_count?: number;            // ç‰©å“æ•°é‡
  total_budget?: string;          // æ€»é¢„ç®—
  items?: Array<{                 // æ¨èç‰©å“åˆ—è¡¨
    name: string;
    price?: number;
    purchase_link?: string;
    reason?: string;
    priority?: number;            // ä¼˜å…ˆçº§
  }>;
  update_frequency?: string;      // æ›´æ–°é¢‘ç‡ï¼šå­£èŠ‚æ€§ã€å¹´åº¦ç­‰
  affiliate?: boolean;            // æ˜¯å¦å¸¦è´§
  target_group?: string[];        // ç›®æ ‡äººç¾¤
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "list_title": "10ä»¶æå‡å¹¸ç¦æ„Ÿçš„å°å®¶ç”µ",
  "item_count": 10,
  "total_budget": "3000ä»¥å†…",
  "items": [
    {
      "name": "æˆ´æ£®å¹é£æœº",
      "price": 2990,
      "reason": "å¿«å¹²æŠ¤å‘",
      "priority": 1
    }
  ],
  "update_frequency": "seasonal",
  "affiliate": true,
  "target_group": ["ç²¾è‡´å¥³æ€§", "é¢„ç®—å……è¶³"]
}
```

### 3.6 æ—…è¡Œæ”»ç•¥ç±»ï¼ˆtutorial + travelï¼‰

```typescript
interface TravelMetaAttributes {
  destination: string;            // ç›®çš„åœ°
  trip_duration?: string;         // è¡Œç¨‹æ—¶é•¿
  budget?: string;                // é¢„ç®—èŒƒå›´
  best_season?: string;           // æœ€ä½³å­£èŠ‚
  itinerary?: Array<{             // è¡Œç¨‹å®‰æ’
    day: number;
    activities: string[];
    meals?: string[];
    accommodation?: string;
  }>;
  transportation?: string;        // äº¤é€šæ–¹å¼
  must_dos?: string[];            // å¿…åšäº‹é¡¹
  must_eats?: string[];           // å¿…åƒç¾é£Ÿ
  tips?: string[];                // æ—…è¡Œè´´å£«
  avoid?: string[];               // é¿å‘æŒ‡å—
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "destination": "æˆéƒ½",
  "trip_duration": "3å¤©2æ™š",
  "budget": "2000-3000",
  "best_season": "ç§‹å­£",
  "itinerary": [
    {
      "day": 1,
      "activities": ["å®½çª„å··å­", "é”¦é‡Œ"],
      "meals": ["é™ˆéº»å©†è±†è…", "é¾™æŠ„æ‰‹"]
    }
  ],
  "transportation": "é«˜é“",
  "must_dos": ["ç†ŠçŒ«åŸºåœ°", "åƒç«é”…"],
  "must_eats": ["ç«é”…", "ä¸²ä¸²", "å…”å¤´"],
  "tips": ["é¿å¼€é»„é‡‘å‘¨", "æå‰è®¢ç¥¨"],
  "avoid": ["æ™¯åŒºå‘¨è¾¹é¤å…", "é»‘è½¦"]
}
```

### 3.7 åˆé›†/æ¦œå•ç±»ï¼ˆcollectionï¼‰

```typescript
interface CollectionMetaAttributes {
  list_title: string;             // æ¦œå•æ ‡é¢˜
  item_count: number;             // é¡¹ç›®æ•°é‡
  ranking_criteria?: string;      // æ’åºæ ‡å‡†
  items: Array<{                  // æ¦œå•é¡¹ç›®
    rank: number;
    name: string;
    description?: string;
    score?: number;
    image_url?: string;
  }>;
  update_date?: string;           // æ›´æ–°æ—¥æœŸ
  data_source?: string;           // æ•°æ®æ¥æº
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "list_title": "æ·±åœ³15å®¶å¿…å»å’–å•¡åº—",
  "item_count": 15,
  "ranking_criteria": "ç»¼åˆè¯„åˆ†",
  "items": [
    {
      "rank": 1,
      "name": "ç¬é—´ Slack",
      "description": "éŸ©ç³»é©¬å¡é¾™é£æ ¼",
      "score": 9.5
    }
  ],
  "update_date": "2026-01",
  "data_source": "ç¼–è¾‘æ¨è"
}
```

---

## 4. æ•°æ®åº“ Schema è®¾è®¡

### 4.1 å­—æ®µå®šä¹‰

```typescript
// src/server/db/schema/tables/xhs.ts

export const xhsImageJobs = pgTable("xhs_image_jobs", {
  // ... ç°æœ‰å­—æ®µ

  // ========== å†…å®¹åˆ†ç±»ä½“ç³» ==========

  // ä¸€çº§ï¼šèµ›é“
  track: text("track"),
  // lifestyle, beauty, fashion, travel, food, home, parenting,
  // fitness, education, tech, pets, finance

  // äºŒçº§ï¼šå†…å®¹ç±»å‹
  category: text("category"),
  // explore, review, tutorial, knowledge, recommendation,
  // vlog, comparison, collection, diy, case_study

  // ========== å…ƒå±æ€§ ==========

  // ç»“æ„åŒ–å…ƒæ•°æ®ï¼ˆæ ¹æ® category ä¸åŒï¼Œç»“æ„ä¸åŒï¼‰
  metaAttributes: jsonb("meta_attributes").$type<XhsMetaAttributes>(),

  // æ ‡ç­¾ï¼ˆç”¨äºæœç´¢å’Œæ¨èï¼‰
  tags: jsonb("tags").$type<string[]>(),

  // SEOå…³é”®è¯
  keywords: jsonb("keywords").$type<string[]>(),

  // ========== å…³è”å­—æ®µï¼ˆå·²å­˜åœ¨äºç³»ç»Ÿä¸­ï¼‰==========
  // imagePromptId: uuid("image_prompt_id")  -> è§†è§‰é£æ ¼ç”±æ­¤ç®¡ç†
  // styleAnalysisId: uuid("style_analysis_id") -> æ–‡æ¡ˆé£æ ¼ç”±æ­¤ç®¡ç†ï¼ˆå¦‚æœæœ‰ï¼‰
});
```

### 4.2 TypeScript ç±»å‹å®šä¹‰

```typescript
// å…ƒå±æ€§è”åˆç±»å‹
type XhsMetaAttributes =
  | ExploreMetaAttributes
  | ReviewMetaAttributes
  | TutorialMetaAttributes
  | KnowledgeMetaAttributes
  | RecommendationMetaAttributes
  | TravelMetaAttributes
  | CollectionMetaAttributes;

// å¯¼å‡ºæ‰€æœ‰ç±»å‹
export type {
  ExploreMetaAttributes,
  ReviewMetaAttributes,
  TutorialMetaAttributes,
  KnowledgeMetaAttributes,
  RecommendationMetaAttributes,
  TravelMetaAttributes,
  CollectionMetaAttributes,
  XhsMetaAttributes,
};
```

---

## 5. è¿ç§» SQL

```sql
-- ============================================================
-- å°çº¢ä¹¦å†…å®¹åˆ†ç±»ä½“ç³»æ‰©å±• - è¿ç§»è„šæœ¬
-- Version: 0013_add_content_taxonomy
-- Created: 2026-01-26
-- ============================================================

BEGIN;

-- 1. æ·»åŠ åˆ†ç±»å­—æ®µ
ALTER TABLE xhs_image_jobs
ADD COLUMN IF NOT EXISTS track text,
ADD COLUMN IF NOT EXISTS category text,
ADD COLUMN IF NOT EXISTS meta_attributes jsonb,
ADD COLUMN IF NOT EXISTS tags jsonb,
ADD COLUMN IF NOT EXISTS keywords jsonb;

-- 2. æ·»åŠ å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN xhs_image_jobs.track IS 'å†…å®¹èµ›é“ï¼šlifestyle, beauty, fashion, travel, food, home, parenting, fitness, education, tech, pets, finance';
COMMENT ON COLUMN xhs_image_jobs.category IS 'å†…å®¹ç±»å‹ï¼šexplore, review, tutorial, knowledge, recommendation, vlog, comparison, collection, diy, case_study';
COMMENT ON COLUMN xhs_image_jobs.meta_attributes IS 'å…ƒå±æ€§ï¼šæ ¹æ®categoryä¸åŒå­˜å‚¨ä¸åŒçš„ç»“æ„åŒ–æ•°æ®ï¼ˆåº—é“ºä¿¡æ¯ã€äº§å“å‚æ•°ç­‰ï¼‰';
COMMENT ON COLUMN xhs_image_jobs.tags IS 'å†…å®¹æ ‡ç­¾æ•°ç»„ï¼Œç”¨äºæœç´¢å’Œæ¨è';
COMMENT ON COLUMN xhs_image_jobs.keywords IS 'SEOå…³é”®è¯æ•°ç»„';

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_track
ON xhs_image_jobs(track)
WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_category
ON xhs_image_jobs(category)
WHERE deleted_at IS NULL;

-- 4. åˆ›å»º GIN ç´¢å¼•ï¼ˆç”¨äº JSONB æŸ¥è¯¢ï¼‰
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_tags
ON xhs_image_jobs USING GIN(tags);

CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_keywords
ON xhs_image_jobs USING GIN(keywords);

CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_meta_attributes
ON xhs_image_jobs USING GIN(meta_attributes);

-- 5. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå¸¸ç”¨æŸ¥è¯¢ç»„åˆï¼‰
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_track_category
ON xhs_image_jobs(track, category)
WHERE deleted_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_user_track_status
ON xhs_image_jobs(user_id, track, status)
WHERE deleted_at IS NULL;

COMMIT;

-- ============================================================
-- éªŒè¯ SQL
-- ============================================================

-- æ£€æŸ¥å­—æ®µæ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'xhs_image_jobs'
  AND column_name IN ('track', 'category', 'meta_attributes', 'tags', 'keywords')
ORDER BY column_name;

-- æ£€æŸ¥ç´¢å¼•
SELECT
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'xhs_image_jobs'
  AND indexname LIKE '%track%' OR indexname LIKE '%category%' OR indexname LIKE '%tags%'
ORDER BY indexname;
```

---

## 6. N8N é…ç½®æ›´æ–°

### 6.1 INSERT SQL æ›´æ–°

```sql
INSERT INTO xhs_image_jobs (
    user_id,
    source_url,
    source_title,
    total_images,
    status,
    started_at,
    image_prompt_id,
    input_content,
    style_prompt,
    generated_config,

    -- âœ¨ æ–°å¢åˆ†ç±»å­—æ®µ
    track,
    category,
    meta_attributes,
    tags,
    keywords
)
VALUES (
    '{{ $json.user_id }}'::uuid,
    '{{ $json.article_link }}',
    '{{ $json.title }}',
    {{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).length }},
    'processing',
    NOW(),
    '{{ $json.prompt_id }}'::uuid,
    $${{ $json.input_content }}$$,
    $${{ $json.style_prompt }}$$,
    '{{ $json.output }}'::jsonb,

    -- âœ¨ æ–°å¢åˆ†ç±»æ•°æ®
    '{{ $json.track }}',
    '{{ $json.category }}',
    '{{ $json.meta_attributes }}'::jsonb,
    '{{ $json.tags }}'::jsonb,
    '{{ $json.keywords }}'::jsonb
)
RETURNING id, created_at;
```

### 6.2 å‰ç«¯éœ€è¦ä¼ å…¥çš„æ•°æ®ç»“æ„

```json
{
  "user_id": "...",
  "article_link": "https://mp.weixin.qq.com/s/xxx",
  "title": "æ·±åœ³ Cafe ç½‘çº¢æ‰“å¡å’–å•¡åº—æ¨è",
  "prompt_id": "...",
  "input_content": "[...]",
  "style_prompt": "...",
  "output": "[...]",

  // âœ¨ æ–°å¢åˆ†ç±»ä¿¡æ¯
  "track": "lifestyle",
  "category": "explore",

  // âœ¨ å…ƒå±æ€§ï¼ˆæ ¹æ® category ä¸åŒï¼Œç»“æ„ä¸åŒï¼‰
  "meta_attributes": {
    "shop_name": "ç¬é—´ Slack",
    "shop_type": "å’–å•¡é¦†",
    "address": "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
    "city": "æ·±åœ³",
    "district": "é¾™ååŒº",
    "opening_date": "2024-09",
    "price_range": "30-60",
    "must_try": ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´", "æ©™æ±ä¸€å¤"],
    "pet_friendly": true,
    "features": ["éŸ©ç³»", "é©¬å¡é¾™", "æ‹ç…§", "æ–°åº—"]
  },

  // âœ¨ æ ‡ç­¾å’Œå…³é”®è¯
  "tags": ["æ·±åœ³å’–å•¡", "éŸ©ç³»å’–å•¡é¦†", "é©¬å¡é¾™é£æ ¼", "æ–°åº—æ¨è", "é¾™åæ¢åº—"],
  "keywords": ["æ·±åœ³", "å’–å•¡", "æ¢åº—", "éŸ©ç³»", "é©¬å¡é¾™", "é¾™å", "ç¬é—´Slack"]
}
```

---

## 7. æŸ¥è¯¢ SQL æ›´æ–°

```sql
SELECT
  -- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯
  j.id AS job_id,
  j.user_id,
  j.source_url,
  j.source_title,
  j.status,
  j.total_images,
  j.completed_images,
  j.publish_status,

  -- âœ¨ åˆ†ç±»ä¿¡æ¯
  j.track,
  j.category,
  j.meta_attributes,
  j.tags,
  j.keywords,

  -- é…ç½®ä¿¡æ¯
  j.input_content,
  j.style_prompt,
  j.generated_config,

  -- å…³è”çš„è§†è§‰é£æ ¼ï¼ˆæ¥è‡ª image_prompts è¡¨ï¼‰
  p.title AS prompt_title,
  p.prompt AS base_prompt,
  p.category AS prompt_category,

  -- å›¾ç‰‡ä¿¡æ¯
  COALESCE(
    json_agg(
      json_build_object(
        'id', i.id,
        'index', i.index,
        'type', i.type,
        'r2_url', i.r2_url,
        'wechat_url', i.wechat_url,
        'core_message', i.core_message,
        'text_content', i.text_content
      ) ORDER BY i.index
    ) FILTER (WHERE i.id IS NOT NULL),
    '[]'::json
  ) AS images

FROM xhs_image_jobs j
LEFT JOIN image_prompts p ON p.id = j.image_prompt_id
LEFT JOIN xhs_images i ON i.job_id = j.id
WHERE j.id = '{{ $json.body.job_id }}'::uuid
GROUP BY j.id, p.title, p.prompt, p.category
LIMIT 1;
```

---

## 8. Agent ä½¿ç”¨ç¤ºä¾‹

### 8.1 æ ¹æ®åˆ†ç±»ç”Ÿæˆä¸ªæ€§åŒ–æ­£æ–‡

```javascript
// N8N Agent èŠ‚ç‚¹
const data = $input.item.json;
const { track, category, meta_attributes, tags } = data;

// æ ¹æ®ä¸åŒç±»å‹ç”Ÿæˆä¸åŒæ¨¡æ¿
const contentGenerators = {
  explore: (data, meta) => {
    const shops = data.generated_config.filter(cfg => cfg.type === 'content');
    return `ğŸ“ ${data.source_title}

${shops.map((shop, i) => {
  const shopMeta = meta.items?.[i] || {};
  return `${i + 1}ï¸âƒ£ ${shop.title}
${shop.subtitle}
${shop.body_points?.join('\n')}
`;
}).join('\n')}

#${tags.join(' #')}`;
  },

  review: (data, meta) => {
    return `ã€æµ‹è¯„ã€‘${meta.product_name}

â­ è¯„åˆ†ï¼š${meta.rating}/5
ğŸ’° ä»·æ ¼ï¼šÂ¥${meta.price}
ğŸ“¦ è§„æ ¼ï¼š${meta.capacity}

âœ… ä¼˜ç‚¹ï¼š
${meta.pros?.map(p => `â€¢ ${p}`).join('\n')}

âŒ ç¼ºç‚¹ï¼š
${meta.cons?.map(c => `â€¢ ${c}`).join('\n')}

ğŸ’¡ é€‚åˆï¼š${meta.suitable_for?.join('ã€')}

${meta.repurchase ? 'âœ¨ å€¼å¾—å›è´­ï¼' : ''}

#${tags.join(' #')}`;
  },

  collection: (data, meta) => {
    return `ğŸ“‹ ${meta.list_title}

${meta.items.map((item, i) => {
  const config = data.generated_config[i];
  return `${item.rank}ï¸âƒ£ ${item.name}
${item.description}
${config?.body_points?.join('\n')}
`;
}).join('\n')}

#${tags.join(' #')}`;
  }
};

// ç”Ÿæˆæ­£æ–‡
const generator = contentGenerators[category] || contentGenerators.explore;
const content = generator(data, meta_attributes);

return [{
  json: {
    title: data.source_title,
    content: content,
    images: data.images.map(img => img.r2_url || img.wechat_url),
    track: track,
    category: category,
    tags: tags,
    keywords: data.keywords
  }
}];
```

### 8.2 åŸºäºåˆ†ç±»çš„æœç´¢å’Œæ¨è

```sql
-- æ¨èç›¸ä¼¼å†…å®¹ï¼ˆåŒèµ›é“ã€åŒç±»å‹ï¼‰
SELECT
  id,
  source_title,
  tags,
  created_at
FROM xhs_image_jobs
WHERE track = 'lifestyle'
  AND category = 'explore'
  AND status = 'completed'
  AND publish_status = 'published'
  AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT 10;

-- æ ‡ç­¾æœç´¢ï¼ˆåŒ…å«æŒ‡å®šæ ‡ç­¾ï¼‰
SELECT *
FROM xhs_image_jobs
WHERE tags @> '["éŸ©ç³»", "å’–å•¡é¦†"]'::jsonb
  AND deleted_at IS NULL
ORDER BY created_at DESC;

-- åœ¨å…ƒå±æ€§ä¸­æœç´¢ï¼ˆæ¢åº—ç±» - æŒ‰åŸå¸‚ï¼‰
SELECT *
FROM xhs_image_jobs
WHERE category = 'explore'
  AND meta_attributes->>'city' = 'æ·±åœ³'
  AND deleted_at IS NULL
ORDER BY created_at DESC;

-- åœ¨å…ƒå±æ€§ä¸­æœç´¢ï¼ˆæµ‹è¯„ç±» - æŒ‰å“ç‰Œï¼‰
SELECT *
FROM xhs_image_jobs
WHERE category = 'review'
  AND meta_attributes->>'brand' = 'EstÃ©e Lauder'
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

---

## 9. æ•°æ®ç¤ºä¾‹å¯¹ç…§

### 9.1 æ¢åº—ä»»åŠ¡å®Œæ•´æ•°æ®

```json
{
  // åŸºç¡€ä¿¡æ¯
  "job_id": "xxx",
  "source_title": "æ·±åœ³ Cafe ç½‘çº¢æ‰“å¡å’–å•¡åº—æ¨è",
  "status": "completed",

  // âœ¨ åˆ†ç±»ä¿¡æ¯
  "track": "lifestyle",
  "category": "explore",

  // âœ¨ å…ƒå±æ€§ï¼ˆæ¢åº—ä¸“ç”¨ï¼‰
  "meta_attributes": {
    "shop_name": "ç¬é—´ Slack",
    "shop_type": "å’–å•¡é¦†",
    "address": "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
    "city": "æ·±åœ³",
    "district": "é¾™ååŒº",
    "price_range": "30-60",
    "must_try": ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´"],
    "pet_friendly": true,
    "features": ["éŸ©ç³»", "æ‹ç…§"]
  },

  // âœ¨ æ ‡ç­¾å’Œå…³é”®è¯
  "tags": ["æ·±åœ³å’–å•¡", "éŸ©ç³»å’–å•¡é¦†", "é¾™åæ¢åº—"],
  "keywords": ["æ·±åœ³", "å’–å•¡", "æ¢åº—", "éŸ©ç³»"],

  // è§†è§‰é£æ ¼ï¼ˆæ¥è‡ª image_prompts è¡¨ï¼‰
  "image_prompt_id": "xxx",
  "prompt_title": "å°çº¢ä¹¦3Dé£æ ¼",

  // ç”Ÿæˆé…ç½®
  "generated_config": [...],
  "images": [...]
}
```

---

## 10. æ€»ç»“

è¿™å¥—ç®€åŒ–çš„åˆ†ç±»ä½“ç³»æä¾›äº†ï¼š

1. **ä¸¤å±‚åˆ†ç±»**ï¼šèµ›é“ï¼ˆTrackï¼‰â†’ ç±»å‹ï¼ˆCategoryï¼‰
2. **çµæ´»çš„å…ƒå±æ€§**ï¼šæ ¹æ®å†…å®¹ç±»å‹å­˜å‚¨ä¸åŒçš„ç»“æ„åŒ–ä¿¡æ¯
3. **æ ‡ç­¾ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šç»´åº¦æœç´¢å’Œæ¨è
4. **ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ**ï¼šè§†è§‰é£æ ¼ç”± `image_prompts` ç®¡ç†

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… çµæ´»çš„ JSONB å­˜å‚¨ï¼Œé€‚åº”ä¸åŒå†…å®¹ç±»å‹
- âœ… å¼ºå¤§çš„æœç´¢èƒ½åŠ›ï¼ˆGIN ç´¢å¼•ï¼‰
- âœ… ä¸ç°æœ‰é£æ ¼ç®¡ç†ç³»ç»Ÿæ— ç¼é›†æˆ

**ä¸‹ä¸€æ­¥**ï¼š
1. æ‰§è¡Œè¿ç§» SQL
2. æ›´æ–° TypeScript Schema
3. ä¿®æ”¹ N8N INSERT SQL
4. å‰ç«¯æ·»åŠ åˆ†ç±»ä¿¡æ¯è¾“å…¥
