# /tasks SDUI 试点设计

## 背景
当前前端已大规模采用 A2UI 协议，但 UI 节点主要在客户端本地构建，未形成服务端下发 UI 的闭环。为验证 SDUI（服务端驱动 UI）的长期可扩展性与工程收益，选择 `/tasks` 页面作为试点。

## 目标
- 在不破坏现有交互的前提下，把 `/tasks` 页面切换为服务端下发 A2UI 节点。
- 保持 Markdown 编辑预览体验，采用客户端即时预览 + 节流保存。
- 最小化改动范围，确保可快速回滚与可观测。

## 方案比较
### 方案 A（推荐）：单页 SDUI + 客户端即时预览 + 节流保存
**做法**：新增 `GET /api/internal/sdui/tasks` 返回 `A2UIResponse`；前端仅渲染与处理 action。Markdown 编辑节点由服务端下发初始值，客户端实时预览并节流保存。
- **KISS**：单页试点，新增一个接口与轻量服务层，复杂度最低。
- **YAGNI**：不引入 schema 版本治理与全局编排，仅做必要闭环。
- **SOLID**：路由做校验与装配，服务层做节点构建，职责清晰。
- **DRY**：节点构建集中到服务端，避免前端重复布局。
- **潜在违背与调整**：客户端维护编辑态存在“状态分散”风险，建议增加 `version/updatedAt` 回传并在保存失败时提示重试。

### 方案 B：混合式（服务端数据 + 前端组装节点）
**做法**：接口返回数据，前端根据数据构建 A2UI 节点，仅局部节点由服务端返回。
- **KISS/YAGNI**：短期改动更少，但演进时容易反复迁移。
- **SOLID/DRY**：布局与节点逻辑容易在前后端重复。
- **潜在违背与调整**：DRY 易被破坏，需强制将“布局/节点构建”固定在服务端或抽成共享 builder。

### 方案 C：回合式 SDUI（服务端权威状态 + 回传节点）
**做法**：前端每次编辑都回传，服务端重算节点并返回。
- **SOLID/DRY**：服务端单一事实源，结构最统一。
- **KISS/YAGNI**：实现复杂、交互延迟高，当前需求偏过度设计。
- **潜在违背与调整**：易违背 KISS/YAGNI，可限制为“保存/发布时回传”。

**推荐结论**：采用方案 A，兼顾体验与长期演进可控性。

## 架构概述
- 新增 SDUI 接口：`GET /api/internal/sdui/tasks`。
- 服务端服务层：拉取任务数据并调用 `transformTaskListToA2UI` 生成节点。
- 前端页面：请求节点后交给 `A2UIRenderer` 渲染；`onAction` 映射到既有业务请求。
- 响应结构：`{ nodes, meta?: { schemaVersion, requestId, nodeCount } }`（`meta` 为可选扩展）。

## 组件与职责
- **Route**：参数校验、鉴权、调用 service、组装响应。
- **Service**：数据查询、节点构建、空态/错误节点生成。
- **Page**：节点请求、渲染、action 分发、本地编辑态与节流保存。

## 数据流与状态
1. 页面加载请求 `/api/internal/sdui/tasks` → 返回 A2UI 节点。
2. 前端渲染节点并绑定 `onAction`。
3. Markdown 编辑：本地即时预览；`onChange` 触发节流保存（800-1200ms）。
4. 保存成功更新 `updatedAt`；保存失败保留本地内容并提示重试。

## 错误处理与回退
- **服务端**：校验失败/空数据时返回 `A2UIEmptyState` 或 `A2UIAlert` 节点。
- **客户端**：网络失败时渲染告警节点 + 重试；渲染异常用 `A2UIFallback`。
- **回滚**：预留 `SDUI_TASKS_ENABLED` 开关（或同等配置）以切回本地构建逻辑。

## 可观察性
- 记录 `requestId`、`schemaVersion`、`nodeCount`、响应耗时。
- 保存接口记录成功率与耗时，便于评估节流策略效果。

## 测试与验证
- **单元测试**：`transformTaskListToA2UI` 关键结构断言。
- **接口测试**：SDUI 端点返回 `nodes` 且符合类型结构。
- **E2E**：页面加载、关键节点渲染、Markdown 节流保存触发与错误提示。

## 风险与缓解
- **节点与 action 不匹配**：新增契约测试或运行时校验。
- **节流保存冲突**：返回 `updatedAt/version`，保存前校验并提示冲突。
- **节点过大导致响应慢**：限制节点深度与分页大小，必要时分页加载。

## 结果预期
- `/tasks` 以 SDUI 方式运行，交互体验不下降。
- 节点构建职责下沉服务端，形成可扩展的 SDUI 模式。
- 后续页面可按同模式渐进迁移。
