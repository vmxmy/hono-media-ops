# Pipeline 快速创作功能设计

> 设计目标：为 ADHD 用户打造低认知负担的一站式内容创作流程

## 概述

新增 `/pipeline` 页面，将素材分析、文章创作、小红书图文生成三大模块串联为单页自动化流水线。

### 核心设计理念

| 原则 | 实现方式 |
|------|----------|
| **决策前置** | 所有用户选择在执行前完成，启动后全自动 |
| **单页体验** | 全程不跳转，在 `/pipeline` 页面完成 |
| **移动优先** | 滑动选择、大按钮、单手可操作 |
| **实时反馈** | 章节流式展示、精确进度条 |
| **可离开** | 后台运行 + 通知召回 |

---

## 用户流程

```
输入 URL + 话题
      ↓
风格分析（约30秒，有动画）
      ↓
确认风格 + 滑动选择视觉风格
      ↓
🚀 开始生成（一键启动）
      ↓
┌─────────────────┐
│ 后台自动执行    │ ← 可离开页面
│ 文章 + 封面 +   │
│ 小红书图文      │
└─────────────────┘
      ↓
✅ 完成通知
      ↓
查看结果 / 发布小红书 / 再来一篇
```

---

## 页面设计

### 1. 入口：极简启动表单

位于页面顶部，始终可见：

```
┌─────────────────────────────────┐
│  🚀 快速创作                    │
│                                 │
│  参考文章 URL                   │
│  ┌─────────────────────────┐    │
│  │ 粘贴链接...              │    │
│  └─────────────────────────┘    │
│                                 │
│  新话题                         │
│  ┌─────────────────────────┐    │
│  │ 想写什么...              │    │
│  └─────────────────────────┘    │
│                                 │
│  ┌─────────────────────────┐    │
│  │     [ 分析风格 → ]       │    │
│  └─────────────────────────┘    │
└─────────────────────────────────┘
```

**设计要点**：
- 只有 2 个必填项：URL 和话题
- 字数等参数使用智能默认值
- URL 支持直接粘贴，自动识别主流平台

---

### 2. 风格分析等待

```
┌─────────────────────────────────┐
│                                 │
│           ◠ ◡ ◠                 │
│      正在分析文章风格...        │
│         约需 30 秒              │
│                                 │
│  ┌─────────────────────────┐    │
│  │ ████████░░░░░░░ 60%     │    │
│  └─────────────────────────┘    │
│                                 │
└─────────────────────────────────┘
```

---

### 3. 风格确认 + 视觉风格选择

风格确认与封面选择合并为一屏，封面风格同时用于文章封面和小红书图文：

```
┌─────────────────────────────────┐
│  ✅ 风格分析完成                │
│                                 │
│  风格：温暖治愈系               │
│  特点：第一人称 · 短句 · 共鸣强  │
│  [展开详情 ↓]                   │
│                                 │
├─────────────────────────────────┤
│                                 │
│  🎨 选择视觉风格 ← 滑动 →       │
│                                 │
│      ┌───────────────────┐      │
│      │                   │      │
│      │                   │      │
│      │     风格预览       │      │
│      │                   │      │
│      │                   │      │
│      └───────────────────┘      │
│        温暖插画 · 98% 匹配      │
│         ● ○ ○ ○                 │
│                                 │
│  💡 此风格同时用于封面和小红书图文│
│                                 │
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐    │
│  │   [ 🚀 开始生成 ]       │    │
│  └─────────────────────────┘    │
│                                 │
│  将生成：文章 + 封面 + 9张图文  │
│  预计耗时：2-3 分钟             │
│                                 │
└─────────────────────────────────┘
```

**滑动选择交互**：

| 手势 | 动作 |
|------|------|
| 左右滑动 | 切换封面风格（带惯性，类似 Tinder） |
| 点击大图 | 放大查看细节 |
| 点击按钮 | 确认选择，开始生成 |

**视觉风格排序**：
- 使用 Embedding 余弦相似度计算匹配度
- 按匹配度降序排列所有可用风格
- 默认选中匹配度最高的第一个

---

### 4. 执行阶段：进度展示

支持长时间生成（10+ 分钟），需要实时反馈：

```
┌─────────────────────────────────┐
│  ⚡ 正在生成...                 │
│                                 │
│  ┌─────────────────────────┐    │
│  │ ██████████░░░░░░ 36%    │    │
│  └─────────────────────────┘    │
│                                 │
│  📄 文章      3/5 章节 ✍️       │
│  📱 小红书    等待中...         │
│                                 │
├─────────────────────────────────┤
│                                 │
│  📖 已生成内容（实时预览）       │
│                                 │
│  ┌─────────────────────────┐    │
│  │ 第一章：寻找内心的锚点   │ ✓  │
│  │ 在这个快节奏的时代...    │    │
│  ├─────────────────────────┤    │
│  │ 第二章：放慢脚步的艺术   │ ✓  │
│  │ 很多人误以为效率就是...  │    │
│  ├─────────────────────────┤    │
│  │ 第三章：正在生成...      │ ◉  │
│  │ ▋ (打字机效果)           │    │
│  └─────────────────────────┘    │
│                                 │
│  💡 可随时离开，完成后通知你    │
│                                 │
└─────────────────────────────────┘
```

**进度计算公式**：

```typescript
function calculateProgress(
  articleCompleted: number,
  articleTotal: number,
  xhsCompleted: number,
  xhsTotal: number
): number {
  const articleProgress = articleCompleted / articleTotal;
  const xhsProgress = xhsCompleted / xhsTotal;

  // 文章占 60%，图文占 40%
  return Math.round((articleProgress * 60) + (xhsProgress * 40));
}
```

**阶段状态图标**：

| 状态 | 图标 | 显示 |
|------|------|------|
| 等待中 | ⏳ | `等待中...` |
| 进行中 | ✍️ / 🖼️ | `3/5 章节` |
| 已完成 | ✅ | `5/5 章节 ✅` |
| 失败 | ❌ | `失败 [重试]` |

---

### 5. 离开页面处理

**离开时确认**：

```
┌─────────────────────────────────┐
│  📱 要离开吗？                  │
│                                 │
│  生成会在后台继续进行           │
│  完成后通过以下方式通知你：     │
│                                 │
│  ☑️ 浏览器通知                  │
│  ☑️ 页面顶部提示                │
│                                 │
│  [ 继续等待 ]  [ 放心离开 ✓ ]   │
│                                 │
└─────────────────────────────────┘
```

**全局状态提示栏**（任意页面顶部）：

```
┌─────────────────────────────────────────────────┐
│ ⚡ 创作进行中：「如何找到内心平静」3/5 章节     │
│                                   [查看详情 →] │
└─────────────────────────────────────────────────┘
```

**完成后**：

```
┌─────────────────────────────────────────────────┐
│ ✅ 创作完成！「如何找到内心平静」已就绪         │
│                        [查看结果 →]  [稍后 ×]  │
└─────────────────────────────────────────────────┘
```

---

### 6. 完成结果页

```
┌─────────────────────────────────┐
│  ✅ 全部完成！                  │
├─────────────────────────────────┤
│                                 │
│  📄 文章                        │
│  ┌─────────────────────────┐    │
│  │        [封面图]         │    │
│  │                         │    │
│  │  标题：如何在忙碌中找到  │    │
│  │        内心的平静        │    │
│  │                         │    │
│  │  2,134 字 · 5 章节      │    │
│  └─────────────────────────┘    │
│                                 │
│  [ 预览文章 ]   [ 复制全文 ]    │
│                                 │
├─────────────────────────────────┤
│                                 │
│  📱 小红书图文 (9张)            │
│                                 │
│  ┌─────┐ ┌─────┐ ┌─────┐       │
│  │  1  │ │  2  │ │  3  │       │
│  └─────┘ └─────┘ └─────┘       │
│  ┌─────┐ ┌─────┐ ┌─────┐       │
│  │  4  │ │  5  │ │  6  │       │
│  └─────┘ └─────┘ └─────┘       │
│  ┌─────┐ ┌─────┐ ┌─────┐       │
│  │  7  │ │  8  │ │  9  │       │
│  └─────┘ └─────┘ └─────┘       │
│                                 │
│  [ 预览大图 ]   [ 下载全部 ]    │
│                                 │
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐    │
│  │   [ 📤 发布到小红书 ]   │    │
│  └─────────────────────────┘    │
│                                 │
│  ┌─────────────────────────┐    │
│  │   [ ➕ 开始新创作 ]     │    │
│  └─────────────────────────┘    │
│                                 │
└─────────────────────────────────┘
```

**操作说明**：

| 操作 | 行为 |
|------|------|
| 预览文章 | 全屏展示文章，支持滚动阅读 |
| 复制全文 | 一键复制 Markdown/纯文本到剪贴板 |
| 点击小图 | 放大查看单张 |
| 预览大图 | 全屏轮播模式，左右滑动切换 |
| 下载全部 | 打包 ZIP 下载 9 张图 |
| 发布到小红书 | 调用 MCP 工具一键发布 |
| 开始新创作 | 回到 Step 1 |

---

### 7. 历史记录列表

位于 `/pipeline` 页面下方：

```
┌─────────────────────────────────┐
│  📋 历史创作                    │
│                                 │
│  ┌─────────────────────────┐    │
│  │ [缩略图] 如何在忙碌中... │    │
│  │          ✅ 已完成       │    │
│  │          3小时前         │    │
│  │    [查看]  [再来一篇]    │    │
│  └─────────────────────────┘    │
│                                 │
│  ┌─────────────────────────┐    │
│  │ [缩略图] 职场沟通的艺术  │    │
│  │          🔄 生成中 78%   │    │
│  │          10分钟前        │    │
│  │          [查看进度]      │    │
│  └─────────────────────────┘    │
│                                 │
│  ┌─────────────────────────┐    │
│  │ [缩略图] 周末好去处      │    │
│  │          ⏸️ 待确认       │    │
│  │          昨天            │    │
│  │    [继续]     [删除]     │    │
│  └─────────────────────────┘    │
│                                 │
└─────────────────────────────────┘
```

**状态与操作**：

| 状态 | 含义 | 可用操作 |
|------|------|----------|
| ⏸️ 待确认 | 风格已分析，等待选择封面 | 继续、删除 |
| 🔄 生成中 | 正在执行 | 查看进度 |
| ✅ 已完成 | 全部产出就绪 | 查看、再来一篇、发布、删除 |
| ❌ 失败 | 执行出错 | 重试、删除 |

---

### 8.「再来一篇」功能

复用上次的风格和视觉设置，只需输入新话题：

```
┌─────────────────────────────────┐
│  🔄 再来一篇                    │
│                                 │
│  复用风格：温暖治愈系 ✓         │
│  复用视觉：温暖插画 ✓           │
│                                 │
│  新话题：                       │
│  ┌─────────────────────────┐    │
│  │ 输入新话题...            │    │
│  └─────────────────────────┘    │
│                                 │
│  [ 🚀 直接生成 ]                │
│                                 │
└─────────────────────────────────┘
```

---

## 技术实现

### 新增数据模型

```typescript
// Pipeline 状态
interface Pipeline {
  id: string;
  userId: string;

  // 输入
  sourceUrl: string;
  topic: string;

  // 风格分析结果
  styleAnalysisId: string | null;

  // 用户选择
  imagePromptId: string | null;

  // 生成结果
  taskId: string | null;        // 关联的文章任务
  xhsJobId: string | null;      // 关联的小红书图文任务

  // 状态
  status: 'analyzing' | 'pending_selection' | 'processing' | 'completed' | 'failed';

  // 进度
  articleTotalChapters: number;
  articleCompletedChapters: number;
  xhsTotalImages: number;
  xhsCompletedImages: number;

  createdAt: Date;
  updatedAt: Date;
}
```

### 新增服务

```
src/server/services/
└── pipeline.service.ts    # Pipeline 业务逻辑
```

主要方法：
- `create(url, topic)` - 创建 pipeline，触发风格分析
- `selectStyle(pipelineId, imagePromptId)` - 保存用户选择
- `start(pipelineId)` - 启动生成流程
- `getProgress(pipelineId)` - 获取进度
- `getHistory(userId)` - 获取历史记录
- `cloneWithNewTopic(pipelineId, newTopic)` - 再来一篇

### 新增路由

```
src/server/api/routers/
└── pipeline.ts           # Pipeline tRPC 路由
```

### 新增页面

```
src/app/pipeline/
└── page.tsx              # Pipeline 主页面
```

### Embedding 匹配

为 `image_prompts` 表添加 embedding 字段：

```sql
ALTER TABLE image_prompts
ADD COLUMN embedding vector(1536);
```

生成时机：创建/更新 image prompt 时自动生成。

查询时：计算文章风格摘要的 embedding，与所有 image_prompts.embedding 计算余弦相似度，按相似度降序返回。

### 前端组件

| 组件 | 功能 |
|------|------|
| `PipelineInput` | 输入表单 |
| `StyleConfirmCard` | 风格确认卡片 |
| `SwipeSelector` | 滑动选择器 |
| `ProgressPanel` | 进度面板 |
| `GlobalStatusBar` | 全局状态栏 |
| `ResultView` | 结果展示 |
| `PipelineHistory` | 历史列表 |

### 技术依赖

| 功能 | 技术方案 |
|------|----------|
| 滑动交互 | `react-swipeable` 或原生 touch 事件 |
| 后台通知 | Web Push Notification API |
| 进度轮询 | React Query `refetchInterval` |
| Embedding | OpenAI text-embedding-3-small |

---

## 导航整合

在侧边栏中，`/pipeline` 作为第一个菜单项，命名为「快速创作」。

```
┌─────────────────┐
│ 🚀 快速创作     │ ← 新增，置顶
│ 📄 文章任务     │
│ 📱 小红书图文   │
│ 📝 素材库       │
│ 🎨 提示词库     │
└─────────────────┘
```

---

## ADHD 友好特性总结

| 特性 | 解决的问题 |
|------|------------|
| 决策前置 | 避免执行中打断思路 |
| 单页体验 | 不跳转不迷路 |
| 滑动选择 | 减少点击，更直觉 |
| 智能排序 | 最佳选项在最前，减少选择压力 |
| 实时预览 | 有事可看，减少焦虑 |
| 后台运行 | 可以离开，不用干等 |
| 通知召回 | 完成后主动提醒 |
| 再来一篇 | 复用选择，一键启动 |
