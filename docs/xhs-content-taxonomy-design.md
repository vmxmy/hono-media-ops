# å°çº¢ä¹¦å†…å®¹åˆ†ç±»ä¸å±æ€§ä½“ç³»è®¾è®¡

## æ¦‚è¿°

è®¾è®¡ä¸€å¥—å®Œæ•´çš„å†…å®¹åˆ†ç±»ä½“ç³»ï¼Œä»èµ›é“ï¼ˆTrackï¼‰â†’ ç±»å‹ï¼ˆCategoryï¼‰â†’ é£æ ¼ï¼ˆStyleï¼‰â†’ å…ƒå±æ€§ï¼ˆMetaï¼‰ï¼Œæ”¯æŒç²¾å‡†çš„å†…å®¹å®šä½å’Œä¸ªæ€§åŒ–æ¨èã€‚

---

## 1. èµ›é“ï¼ˆTrackï¼‰- ä¸€çº§åˆ†ç±»

èµ›é“æ˜¯æœ€é¡¶å±‚çš„å†…å®¹é¢†åŸŸåˆ’åˆ†ï¼Œå†³å®šäº†å†…å®¹çš„æ ¸å¿ƒå—ä¼—å’Œå•†ä¸šä»·å€¼ã€‚

| èµ›é“ä»£ç  | èµ›é“åç§° | æè¿° | å…¸å‹å—ä¼— |
|---------|---------|------|---------|
| `lifestyle` | ç”Ÿæ´»æ–¹å¼ | ç¾é£Ÿã€å’–å•¡ã€æ¢åº—ã€home decor | éƒ½å¸‚ç™½é¢†ã€ç²¾è‡´ç”Ÿæ´»è¿½æ±‚è€… |
| `beauty` | ç¾å¦†ä¸ªæŠ¤ | æŠ¤è‚¤ã€å½©å¦†ã€å‘å‹ã€é¦™æ°´ | å¥³æ€§ä¸ºä¸»ï¼Œ18-35å² |
| `fashion` | æ—¶å°šç©¿æ­ | æœè£…ã€é…é¥°ã€ç©¿æ­æ•™ç¨‹ | æ—¶å°šæ•æ„Ÿäººç¾¤ |
| `travel` | æ—…è¡Œå‡ºæ¸¸ | ç›®çš„åœ°æ”»ç•¥ã€é…’åº—æ°‘å®¿ã€æ™¯ç‚¹ | æ—…æ¸¸çˆ±å¥½è€… |
| `food` | ç¾é£Ÿçƒ¹é¥ª | é£Ÿè°±ã€çƒ˜ç„™ã€é¤å…æ¨è | ç¾é£Ÿçˆ±å¥½è€… |
| `home` | å®¶å±…å®¶è£… | è£…ä¿®ã€æ”¶çº³ã€å®¶ç”µã€è½¯è£… | æœ‰æˆ¿ä¸€æ—ã€æ–°å©šå¤«å¦‡ |
| `parenting` | æ¯å©´è‚²å„¿ | å­•æœŸã€è‚²å„¿ã€æ—©æ•™ã€ç©å…· | å‡†å¦ˆå¦ˆã€0-6å²çˆ¶æ¯ |
| `fitness` | å¥èº«è¿åŠ¨ | å¥èº«ã€ç‘œä¼½ã€è·‘æ­¥ã€å‡è„‚ | å¥èº«çˆ±å¥½è€… |
| `education` | çŸ¥è¯†å­¦ä¹  | æŠ€èƒ½ã€è€ƒè¯ã€è¯­è¨€ã€è¯»ä¹¦ | å­¦ç”Ÿã€èŒåœºäºº |
| `tech` | æ•°ç ç§‘æŠ€ | æ‰‹æœºã€ç”µè„‘ã€æ™ºèƒ½å®¶å±… | ç§‘æŠ€çˆ±å¥½è€… |
| `pets` | èŒå®  | å…»å® ã€å® ç‰©ç”¨å“ã€è®­ç»ƒ | å® ç‰©ä¸»äºº |
| `finance` | ç†è´¢æŠ•èµ„ | ç†è´¢ã€åŸºé‡‘ã€ä¿é™©ã€çœé’± | ç†è´¢æ„è¯†äººç¾¤ |

---

## 2. å†…å®¹ç±»å‹ï¼ˆCategoryï¼‰- äºŒçº§åˆ†ç±»

å†…å®¹ç±»å‹å®šä¹‰äº†å†…å®¹çš„å‘ˆç°å½¢å¼å’Œåˆ›ä½œç›®çš„ã€‚

| ç±»å‹ä»£ç  | ç±»å‹åç§° | æè¿° | é€‚ç”¨èµ›é“ | ç‰¹ç‚¹ |
|---------|---------|------|---------|------|
| `explore` | æ¢åº—/æ¢è®¿ | å®åœ°æ¢è®¿ã€ä½“éªŒåˆ†äº« | lifestyle, food, travel | å¼ºåœºæ™¯ã€é‡æ°›å›´ |
| `review` | æµ‹è¯„/è¯„æµ‹ | äº§å“æ¨ªè¯„ã€æ·±åº¦æµ‹è¯• | beauty, tech, home | æ•°æ®è¯¦å®ã€å¯¹æ¯”æ¸…æ™° |
| `tutorial` | æ•™ç¨‹/æ”»ç•¥ | æ­¥éª¤æ•™å­¦ã€æ“ä½œæŒ‡å— | beauty, food, education | ç»“æ„åŒ–ã€å¯å¤åˆ¶ |
| `knowledge` | å¹²è´§ç§‘æ™® | çŸ¥è¯†åˆ†äº«ã€åŸç†è§£æ | education, finance, fitness | ä¿¡æ¯å¯†åº¦é«˜ |
| `recommendation` | ç§è‰æ¨è | å¥½ç‰©åˆ†äº«ã€æ¸…å•æ¨è | å…¨èµ›é“é€šç”¨ | å¼ºè½¬åŒ–ã€å¸¦è´§å±æ€§ |
| `lifestyle_vlog` | ç”Ÿæ´»è®°å½• | æ—¥å¸¸vlogã€éšæ‰‹æ‹ | lifestyle, travel, pets | çœŸå®ã€è½»æ¾ |
| `comparison` | å¯¹æ¯”é€‰è´­ | A vs Bã€é€‰è´­æŒ‡å— | beauty, tech, home | å†³ç­–è¾…åŠ© |
| `collection` | åˆé›†/æ¦œå• | Top Nã€ç›˜ç‚¹ | å…¨èµ›é“é€šç”¨ | ä¿¡æ¯æ•´åˆ |
| `diy` | DIY/æ‰‹å·¥ | æ‰‹ä½œã€æ”¹é€ ã€åˆ›æ„ | home, food, fashion | åˆ›æ„ã€åŠ¨æ‰‹ |
| `case_study` | æ¡ˆä¾‹åˆ†äº« | æˆåŠŸæ¡ˆä¾‹ã€æ”¹é€ å‰å | home, fashion, fitness | è§†è§‰å†²å‡» |

---

## 3. å†…å®¹é£æ ¼ï¼ˆStyleï¼‰- ä¸‰çº§åˆ†ç±»

é£æ ¼å®šä¹‰äº†å†…å®¹çš„è°ƒæ€§ã€å™äº‹æ–¹å¼å’Œæƒ…æ„Ÿè¡¨è¾¾ã€‚

### 3.1 è§†è§‰é£æ ¼

| é£æ ¼ä»£ç  | é£æ ¼åç§° | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|---------|
| `minimalist` | æç®€é£ | ç•™ç™½å¤šã€è‰²å½©å°‘ã€æ„å›¾ç®€æ´ | å®¶å±…ã€æ—¶å°šã€äº§å“ |
| `dopamine` | å¤šå·´èƒºé£ | é«˜é¥±å’Œè‰²ã€æ´»åŠ›ã€å¿«ä¹ | æ¢åº—ã€ç¾é£Ÿã€ç©¿æ­ |
| `vintage` | å¤å¤é£ | æ€€æ—§è‰²è°ƒã€èƒ¶ç‰‡è´¨æ„Ÿ | å’–å•¡é¦†ã€æ—…è¡Œã€ç©¿æ­ |
| `natural` | è‡ªç„¶é£ | ç»¿æ¤ã€æœ¨è´¨ã€æ¸©æš– | å®¶å±…ã€å’–å•¡ã€ç”Ÿæ´» |
| `modern` | ç°ä»£ç®€çº¦ | çº¿æ¡æ„Ÿã€å‡ ä½•ã€å†·è‰² | ç§‘æŠ€ã€å®¶å±…ã€åŠå…¬ |
| `kawaii` | å¯çˆ±å¡é€š | å¡é€šå…ƒç´ ã€ç²‰å«©è‰² | ç¾ï¿½ï¿½ï¿½ã€æ¢åº—ã€æ¯å©´ |
| `luxury` | é«˜çº§æ„Ÿ | ä½é¥±å’Œã€è´¨æ„Ÿã€å…‹åˆ¶ | æ—¶å°šã€ç¾å¦†ã€é…’åº— |

### 3.2 æ–‡æ¡ˆé£æ ¼

| é£æ ¼ä»£ç  | é£æ ¼åç§° | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------|---------|
| `casual` | å£è¯­åŒ– | èŠå¤©æ„Ÿã€æ¥åœ°æ°”ã€emojiå¤š | æ—¥å¸¸åˆ†äº«ã€vlog |
| `professional` | ä¸“ä¸šä¸¥è°¨ | æœ¯è¯­å‡†ç¡®ã€é€»è¾‘æ¸…æ™° | ç§‘æ™®ã€æ•™ç¨‹ã€æµ‹è¯„ |
| `storytelling` | æ•…äº‹å™äº‹ | æœ‰æƒ…èŠ‚ã€æœ‰èµ·ä¼ | æ—…è¡Œã€æ¢åº—ã€æ¡ˆä¾‹ |
| `listicle` | æ¸…å•å¼ | ç»“æ„åŒ–ã€è¦ç‚¹æ˜ç¡® | åˆé›†ã€æ”»ç•¥ã€æ¦œå• |
| `humorous` | å¹½é»˜æç¬‘ | æ®µå­ã€æ¢—ã€åè½¬ | ç”Ÿæ´»ã€åæ§½ã€å¯¹æ¯” |
| `emotional` | æƒ…æ„Ÿå…±é¸£ | èµ°å¿ƒã€å…±æƒ…ã€æ²»æ„ˆ | ç”Ÿæ´»ã€å® ç‰©ã€è‚²å„¿ |

---

## 4. å…ƒå±æ€§ï¼ˆMeta Attributesï¼‰

æ ¹æ®ä¸åŒèµ›é“å’Œç±»å‹ï¼Œå®šä¹‰å¸¸ç”¨çš„ç»“æ„åŒ–å±æ€§ã€‚

### 4.1 æ¢åº—ç±»ï¼ˆexploreï¼‰

```json
{
  "track": "lifestyle",
  "category": "explore",
  "visual_style": "dopamine",
  "text_style": "casual",

  "meta": {
    "shop_name": "ç¬é—´ Slack",
    "shop_type": "å’–å•¡é¦†",
    "address": "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
    "opening_date": "2024-09",
    "price_range": "30-60",
    "must_try": ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´", "æ©™æ±ä¸€å¤"],
    "tags": ["éŸ©ç³»", "é©¬å¡é¾™", "æ‹ç…§", "æ–°åº—"],
    "best_time": "ä¸‹åˆèŒ¶æ—¶æ®µ",
    "transportation": "åœ°é“Xå·çº¿XXç«™",
    "reservation_required": false,
    "pet_friendly": true,
    "parking_available": false
  }
}
```

### 4.2 æµ‹è¯„ç±»ï¼ˆreviewï¼‰

```json
{
  "track": "beauty",
  "category": "review",
  "visual_style": "modern",
  "text_style": "professional",

  "meta": {
    "product_name": "é›…è¯—å…°é»›å°æ£•ç“¶",
    "brand": "EstÃ©e Lauder",
    "price": 780,
    "capacity": "50ml",
    "rating": 4.5,
    "pros": ["å¸æ”¶å¿«", "æäº®", "ä¿®æŠ¤"],
    "cons": ["ä»·æ ¼è´µ", "é¦™å‘³é‡"],
    "skin_type": ["å¹²çš®", "æ··åˆçš®"],
    "usage_duration": "30å¤©",
    "repurchase": true,
    "alternatives": ["å…°è”»å°é»‘ç“¶", "SK-IIç¥ä»™æ°´"]
  }
}
```

### 4.3 æ•™ç¨‹ç±»ï¼ˆtutorialï¼‰

```json
{
  "track": "beauty",
  "category": "tutorial",
  "visual_style": "minimalist",
  "text_style": "listicle",

  "meta": {
    "title": "æ—¥å¸¸é€šå‹¤å¦†æ•™ç¨‹",
    "difficulty": "easy",
    "time_required": "15åˆ†é’Ÿ",
    "steps": 7,
    "products_needed": ["ç²‰åº•æ¶²", "çœ¼å½±ç›˜", "å£çº¢"],
    "suitable_for": ["æ–°æ‰‹", "å­¦ç”Ÿå…š"],
    "occasion": ["ä¸Šç­", "çº¦ä¼š", "æ—¥å¸¸"],
    "season": ["å››å­£é€šç”¨"]
  }
}
```

### 4.4 å¹²è´§ç§‘æ™®ç±»ï¼ˆknowledgeï¼‰

```json
{
  "track": "fitness",
  "category": "knowledge",
  "visual_style": "modern",
  "text_style": "professional",

  "meta": {
    "topic": "HIITè®­ç»ƒåŸç†",
    "knowledge_depth": "intermediate",
    "reading_time": "5åˆ†é’Ÿ",
    "key_points": ["ä»€ä¹ˆæ˜¯HIIT", "ç‡ƒè„‚åŸç†", "è®­ç»ƒæ–¹æ¡ˆ"],
    "references": ["è®ºæ–‡é“¾æ¥", "ä¹¦ç±"],
    "difficulty": "medium",
    "target_audience": ["å¥èº«çˆ±å¥½è€…", "å‡è„‚äººç¾¤"]
  }
}
```

### 4.5 ç§è‰æ¨èç±»ï¼ˆrecommendationï¼‰

```json
{
  "track": "home",
  "category": "recommendation",
  "visual_style": "natural",
  "text_style": "emotional",

  "meta": {
    "list_title": "10ä»¶æå‡å¹¸ç¦æ„Ÿçš„å°å®¶ç”µ",
    "item_count": 10,
    "total_budget": "3000ä»¥å†…",
    "items": [
      {
        "name": "æˆ´æ£®å¹é£æœº",
        "price": 2990,
        "purchase_link": "...",
        "reason": "å¿«å¹²æŠ¤å‘"
      }
    ],
    "update_frequency": "seasonal",
    "affiliate": true
  }
}
```

### 4.6 æ—…è¡Œæ”»ç•¥ç±»ï¼ˆtutorial + travelï¼‰

```json
{
  "track": "travel",
  "category": "tutorial",
  "visual_style": "vintage",
  "text_style": "storytelling",

  "meta": {
    "destination": "æˆéƒ½",
    "trip_duration": "3å¤©2æ™š",
    "budget": "2000-3000",
    "season": "ç§‹å­£æœ€ä½³",
    "itinerary": [
      {
        "day": 1,
        "activities": ["å®½çª„å··å­", "é”¦é‡Œ", "æ˜¥ç†™è·¯"],
        "meals": ["é™ˆéº»å©†è±†è…", "é¾™æŠ„æ‰‹"]
      }
    ],
    "transportation": "é«˜é“",
    "accommodation": ["æ°‘å®¿æ¨è", "é…’åº—æ¨è"],
    "must_dos": ["ç†ŠçŒ«åŸºåœ°", "åƒç«é”…"],
    "tips": ["é¿å¼€é»„é‡‘å‘¨", "æå‰è®¢ç¥¨"]
  }
}
```

---

## 5. æ•°æ®åº“ Schema è®¾è®¡

### 5.1 æ ¸å¿ƒå­—æ®µæ‰©å±•

```typescript
// src/server/db/schema/tables/xhs.ts

export const xhsImageJobs = pgTable("xhs_image_jobs", {
  // ... ç°æœ‰å­—æ®µ

  // ========== å†…å®¹åˆ†ç±»ä½“ç³» ==========

  // ä¸€çº§ï¼šèµ›é“
  track: text("track"),
  // lifestyle, beauty, fashion, travel, food, home, parenting,
  // fitness, education, tech, pets, finance

  // äºŒçº§ï¼šå†…å®¹ç±»å‹
  category: text("category"),
  // explore, review, tutorial, knowledge, recommendation,
  // lifestyle_vlog, comparison, collection, diy, case_study

  // ä¸‰çº§ï¼šé£æ ¼
  visualStyle: text("visual_style"),
  // minimalist, dopamine, vintage, natural, modern, kawaii, luxury

  textStyle: text("text_style"),
  // casual, professional, storytelling, listicle, humorous, emotional

  // ========== å…ƒå±æ€§ ==========

  // ç»“æ„åŒ–å…ƒæ•°æ®ï¼ˆæ ¹æ® category ä¸åŒï¼Œå­—æ®µä¸åŒï¼‰
  metaAttributes: jsonb("meta_attributes").$type<XhsMetaAttributes>(),

  // æ ‡ç­¾ï¼ˆç”¨äºæœç´¢å’Œæ¨èï¼‰
  tags: jsonb("tags").$type<string[]>(),

  // SEOå…³é”®è¯
  keywords: jsonb("keywords").$type<string[]>(),
});
```

### 5.2 TypeScript ç±»å‹å®šä¹‰

```typescript
// å…ƒå±æ€§åŸºç±»
interface BaseMetaAttributes {
  created_by?: string;
  last_updated?: string;
}

// æ¢åº—ç±»å…ƒå±æ€§
interface ExploreMetaAttributes extends BaseMetaAttributes {
  shop_name: string;
  shop_type?: string;
  address?: string;
  opening_date?: string;
  price_range?: string;
  must_try?: string[];
  tags?: string[];
  best_time?: string;
  transportation?: string;
  reservation_required?: boolean;
  pet_friendly?: boolean;
  parking_available?: boolean;
}

// æµ‹è¯„ç±»å…ƒå±æ€§
interface ReviewMetaAttributes extends BaseMetaAttributes {
  product_name: string;
  brand?: string;
  price?: number;
  capacity?: string;
  rating?: number;
  pros?: string[];
  cons?: string[];
  skin_type?: string[];
  usage_duration?: string;
  repurchase?: boolean;
  alternatives?: string[];
}

// æ•™ç¨‹ç±»å…ƒå±æ€§
interface TutorialMetaAttributes extends BaseMetaAttributes {
  title: string;
  difficulty?: 'easy' | 'medium' | 'hard';
  time_required?: string;
  steps?: number;
  products_needed?: string[];
  suitable_for?: string[];
  occasion?: string[];
  season?: string[];
}

// å¹²è´§ç§‘æ™®ç±»å…ƒå±æ€§
interface KnowledgeMetaAttributes extends BaseMetaAttributes {
  topic: string;
  knowledge_depth?: 'beginner' | 'intermediate' | 'advanced';
  reading_time?: string;
  key_points?: string[];
  references?: string[];
  difficulty?: string;
  target_audience?: string[];
}

// ç§è‰æ¨èç±»å…ƒå±æ€§
interface RecommendationMetaAttributes extends BaseMetaAttributes {
  list_title?: string;
  item_count?: number;
  total_budget?: string;
  items?: Array<{
    name: string;
    price?: number;
    purchase_link?: string;
    reason?: string;
  }>;
  update_frequency?: string;
  affiliate?: boolean;
}

// è”åˆç±»å‹
type XhsMetaAttributes =
  | ExploreMetaAttributes
  | ReviewMetaAttributes
  | TutorialMetaAttributes
  | KnowledgeMetaAttributes
  | RecommendationMetaAttributes;
```

---

## 6. è¿ç§» SQL

```sql
-- ============================================================
-- å°çº¢ä¹¦å†…å®¹åˆ†ç±»ä½“ç³»æ‰©å±• - è¿ç§»è„šæœ¬
-- ============================================================

BEGIN;

-- 1. æ·»åŠ åˆ†ç±»å­—æ®µ
ALTER TABLE xhs_image_jobs
ADD COLUMN IF NOT EXISTS track text,
ADD COLUMN IF NOT EXISTS category text,
ADD COLUMN IF NOT EXISTS visual_style text,
ADD COLUMN IF NOT EXISTS text_style text,
ADD COLUMN IF NOT EXISTS meta_attributes jsonb,
ADD COLUMN IF NOT EXISTS tags jsonb,
ADD COLUMN IF NOT EXISTS keywords jsonb;

-- 2. æ·»åŠ å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN xhs_image_jobs.track IS 'å†…å®¹èµ›é“ï¼šlifestyle, beauty, fashion, travel, food, home, etc.';
COMMENT ON COLUMN xhs_image_jobs.category IS 'å†…å®¹ç±»å‹ï¼šexplore, review, tutorial, knowledge, recommendation, etc.';
COMMENT ON COLUMN xhs_image_jobs.visual_style IS 'è§†è§‰é£æ ¼ï¼šminimalist, dopamine, vintage, natural, modern, kawaii, luxury';
COMMENT ON COLUMN xhs_image_jobs.text_style IS 'æ–‡æ¡ˆé£æ ¼ï¼šcasual, professional, storytelling, listicle, humorous, emotional';
COMMENT ON COLUMN xhs_image_jobs.meta_attributes IS 'å…ƒå±æ€§ï¼šæ ¹æ®categoryä¸åŒå­˜å‚¨ä¸åŒçš„ç»“æ„åŒ–æ•°æ®';
COMMENT ON COLUMN xhs_image_jobs.tags IS 'å†…å®¹æ ‡ç­¾æ•°ç»„ï¼Œç”¨äºæœç´¢å’Œæ¨è';
COMMENT ON COLUMN xhs_image_jobs.keywords IS 'SEOå…³é”®è¯æ•°ç»„';

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_track ON xhs_image_jobs(track);
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_category ON xhs_image_jobs(category);
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_visual_style ON xhs_image_jobs(visual_style);

-- 4. åˆ›å»º GIN ç´¢å¼•ï¼ˆç”¨äº JSONB æŸ¥è¯¢å’Œå…¨æ–‡æœç´¢ï¼‰
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_tags ON xhs_image_jobs USING GIN(tags);
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_keywords ON xhs_image_jobs USING GIN(keywords);
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_meta_attributes ON xhs_image_jobs USING GIN(meta_attributes);

-- 5. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆå¸¸ç”¨æŸ¥è¯¢ç»„åˆï¼‰
CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_track_category
ON xhs_image_jobs(track, category);

CREATE INDEX IF NOT EXISTS idx_xhs_image_jobs_user_track_status
ON xhs_image_jobs(user_id, track, status);

COMMIT;
```

---

## 7. N8N é…ç½®æ›´æ–°

### 7.1 INSERT SQL æ›´æ–°

```sql
INSERT INTO xhs_image_jobs (
    user_id,
    source_url,
    source_title,
    total_images,
    status,
    started_at,
    image_prompt_id,
    input_content,
    style_prompt,
    generated_config,

    -- âœ¨ æ–°å¢åˆ†ç±»å­—æ®µ
    track,
    category,
    visual_style,
    text_style,
    meta_attributes,
    tags,
    keywords
)
VALUES (
    '{{ $json.user_id }}'::uuid,
    '{{ $json.article_link }}',
    '{{ $json.title }}',
    {{ JSON.parse($json.output.replace(/```json/g, '').replace(/```/g, '').trim()).length }},
    'processing',
    NOW(),
    '{{ $json.prompt_id }}'::uuid,
    $${{ $json.input_content }}$$,
    $${{ $json.style_prompt }}$$,
    '{{ $json.output }}'::jsonb,

    -- âœ¨ æ–°å¢åˆ†ç±»æ•°æ®
    '{{ $json.track }}',
    '{{ $json.category }}',
    '{{ $json.visual_style }}',
    '{{ $json.text_style }}',
    '{{ $json.meta_attributes }}'::jsonb,
    '{{ $json.tags }}'::jsonb,
    '{{ $json.keywords }}'::jsonb
)
RETURNING id, created_at;
```

### 7.2 å‰ç«¯/ä¸Šæ¸¸éœ€è¦ä¼ å…¥çš„æ•°æ®

```json
{
  "user_id": "...",
  "article_link": "...",
  "title": "æ·±åœ³ Cafe ç½‘çº¢æ‰“å¡å’–å•¡åº—æ¨è",
  "prompt_id": "...",
  "input_content": "[...]",
  "style_prompt": "...",
  "output": "[...]",

  // âœ¨ æ–°å¢åˆ†ç±»ä¿¡æ¯
  "track": "lifestyle",
  "category": "explore",
  "visual_style": "dopamine",
  "text_style": "casual",

  "meta_attributes": {
    "shop_name": "ç¬é—´ Slack",
    "shop_type": "å’–å•¡é¦†",
    "address": "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
    "price_range": "30-60",
    "must_try": ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´", "æ©™æ±ä¸€å¤"],
    "tags": ["éŸ©ç³»", "é©¬å¡é¾™", "æ‹ç…§"],
    "pet_friendly": true
  },

  "tags": ["æ·±åœ³å’–å•¡", "éŸ©ç³»å’–å•¡é¦†", "é©¬å¡é¾™é£æ ¼", "æ–°åº—æ¨è"],
  "keywords": ["æ·±åœ³", "å’–å•¡", "æ¢åº—", "éŸ©ç³»", "é©¬å¡é¾™"]
}
```

---

## 8. æŸ¥è¯¢ SQL æ›´æ–°

```sql
SELECT
  -- ä»»åŠ¡åŸºæœ¬ä¿¡æ¯
  j.id AS job_id,
  j.user_id,
  j.source_url,
  j.source_title,
  j.status,

  -- âœ¨ åˆ†ç±»ä¿¡æ¯
  j.track,
  j.category,
  j.visual_style,
  j.text_style,
  j.meta_attributes,
  j.tags,
  j.keywords,

  -- é…ç½®ä¿¡æ¯
  j.input_content,
  j.style_prompt,
  j.generated_config,

  -- å›¾ç‰‡ä¿¡æ¯
  COALESCE(
    json_agg(
      json_build_object(
        'id', i.id,
        'index', i.index,
        'type', i.type,
        'r2_url', i.r2_url,
        'core_message', i.core_message
      ) ORDER BY i.index
    ) FILTER (WHERE i.id IS NOT NULL),
    '[]'::json
  ) AS images

FROM xhs_image_jobs j
LEFT JOIN xhs_images i ON i.job_id = j.id
WHERE j.id = '{{ $json.body.job_id }}'::uuid
GROUP BY j.id
LIMIT 1;
```

---

## 9. ä½¿ç”¨ç¤ºä¾‹

### 9.1 åˆ›å»ºæ¢åº—ä»»åŠ¡

```typescript
const exploreShopTask = {
  track: "lifestyle",
  category: "explore",
  visual_style: "dopamine",
  text_style: "casual",

  meta_attributes: {
    shop_name: "ç¬é—´ Slack",
    shop_type: "å’–å•¡é¦†",
    address: "æ·±åœ³é¾™ååŒºé”¦é¾™æ¥¼ b4 æ ‹ 301",
    opening_date: "2024-09",
    price_range: "30-60",
    must_try: ["è“æŸ‘å†°æ·‡æ·‹æ±½æ°´", "æ©™æ±ä¸€å¤"],
    tags: ["éŸ©ç³»", "é©¬å¡é¾™", "æ‹ç…§", "æ–°åº—"],
    best_time: "ä¸‹åˆèŒ¶æ—¶æ®µ",
    pet_friendly: true,
    parking_available: false
  },

  tags: ["æ·±åœ³å’–å•¡", "éŸ©ç³»å’–å•¡é¦†", "é©¬å¡é¾™é£æ ¼", "æ–°åº—æ¨è"],
  keywords: ["æ·±åœ³", "å’–å•¡", "æ¢åº—", "éŸ©ç³»", "é©¬å¡é¾™", "é¾™å"]
};
```

### 9.2 Agent ä½¿ç”¨åˆ†ç±»ä¿¡æ¯ç”Ÿæˆæ­£æ–‡

```javascript
// N8N Agent èŠ‚ç‚¹
const data = $input.item.json;

// æ ¹æ® category é€‰æ‹©æ¨¡æ¿
const templates = {
  explore: (data) => `ğŸ“ ${data.source_title}

${data.generated_config.map((cfg, i) => `
${i + 1}ï¸âƒ£ ${cfg.title}
${cfg.subtitle}
${cfg.body_points?.join('\n')}
`).join('\n')}

#${data.tags?.join(' #')}`,

  review: (data) => `ã€æµ‹è¯„ã€‘${data.meta_attributes.product_name}

â­ è¯„åˆ†ï¼š${data.meta_attributes.rating}/5
ğŸ’° ä»·æ ¼ï¼šÂ¥${data.meta_attributes.price}

âœ… ä¼˜ç‚¹ï¼š
${data.meta_attributes.pros?.map(p => `â€¢ ${p}`).join('\n')}

âŒ ç¼ºç‚¹ï¼š
${data.meta_attributes.cons?.map(c => `â€¢ ${c}`).join('\n')}

#${data.tags?.join(' #')}`,
};

const template = templates[data.category] || templates.explore;
const content = template(data);

return [{
  json: {
    title: data.source_title,
    content: content,
    images: data.images.map(img => img.r2_url),
    track: data.track,
    category: data.category,
    tags: data.tags
  }
}];
```

---

## 10. æ¨èå’Œæœç´¢ä¼˜åŒ–

### 10.1 åŸºäºåˆ†ç±»çš„æ¨èæŸ¥è¯¢

```sql
-- æ¨èç›¸ä¼¼å†…å®¹ï¼ˆåŒèµ›é“ã€åŒç±»å‹ï¼‰
SELECT *
FROM xhs_image_jobs
WHERE track = 'lifestyle'
  AND category = 'explore'
  AND status = 'completed'
  AND publish_status = 'published'
  AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT 10;
```

### 10.2 æ ‡ç­¾æœç´¢

```sql
-- æŸ¥æ‰¾åŒ…å«ç‰¹å®šæ ‡ç­¾çš„å†…å®¹
SELECT *
FROM xhs_image_jobs
WHERE tags @> '["éŸ©ç³»", "å’–å•¡é¦†"]'::jsonb
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

### 10.3 å…¨æ–‡æœç´¢

```sql
-- åœ¨ meta_attributes ä¸­æœç´¢
SELECT *
FROM xhs_image_jobs
WHERE meta_attributes @> '{"shop_type": "å’–å•¡é¦†"}'::jsonb
  OR meta_attributes->'tags' @> '["éŸ©ç³»"]'::jsonb
ORDER BY created_at DESC;
```

---

## 11. åç»­ä¼˜åŒ–å»ºè®®

### 11.1 åˆ›å»ºæšä¸¾è¡¨ï¼ˆå¯é€‰ï¼‰

ä¸ºäº†æ›´å¥½çš„æ•°æ®ä¸€è‡´æ€§ï¼Œå¯ä»¥åˆ›å»ºæšä¸¾è¡¨ï¼š

```sql
-- èµ›é“æšä¸¾è¡¨
CREATE TABLE xhs_tracks (
  code text PRIMARY KEY,
  name text NOT NULL,
  description text,
  icon text,
  sort_order integer,
  created_at timestamp DEFAULT NOW()
);

-- ç±»å‹æšä¸¾è¡¨
CREATE TABLE xhs_categories (
  code text PRIMARY KEY,
  name text NOT NULL,
  description text,
  applicable_tracks jsonb, -- é€‚ç”¨çš„èµ›é“åˆ—è¡¨
  sort_order integer,
  created_at timestamp DEFAULT NOW()
);

-- æ’å…¥æ•°æ®
INSERT INTO xhs_tracks (code, name, description, sort_order) VALUES
('lifestyle', 'ç”Ÿæ´»æ–¹å¼', 'ç¾é£Ÿã€å’–å•¡ã€æ¢åº—ã€home decor', 1),
('beauty', 'ç¾å¦†ä¸ªæŠ¤', 'æŠ¤è‚¤ã€å½©å¦†ã€å‘å‹ã€é¦™æ°´', 2),
-- ...
```

### 11.2 æ·»åŠ å¤–é”®çº¦æŸ

```sql
ALTER TABLE xhs_image_jobs
ADD CONSTRAINT fk_xhs_image_jobs_track
FOREIGN KEY (track) REFERENCES xhs_tracks(code);

ALTER TABLE xhs_image_jobs
ADD CONSTRAINT fk_xhs_image_jobs_category
FOREIGN KEY (category) REFERENCES xhs_categories(code);
```

### 11.3 æ•°æ®ç»Ÿè®¡è§†å›¾

```sql
-- åˆ›å»ºç»Ÿè®¡è§†å›¾
CREATE VIEW xhs_content_stats AS
SELECT
  track,
  category,
  COUNT(*) as total_jobs,
  COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_jobs,
  COUNT(CASE WHEN publish_status = 'published' THEN 1 END) as published_jobs,
  AVG(total_images) as avg_images
FROM xhs_image_jobs
WHERE deleted_at IS NULL
GROUP BY track, category
ORDER BY track, category;
```

---

## 12. æ€»ç»“

è¿™å¥—åˆ†ç±»ä½“ç³»æä¾›äº†ï¼š

1. **ä¸‰å±‚åˆ†ç±»ç»“æ„**ï¼šèµ›é“ â†’ ç±»å‹ â†’ é£æ ¼
2. **çµæ´»çš„å…ƒå±æ€§**ï¼šæ ¹æ®å†…å®¹ç±»å‹å­˜å‚¨ä¸åŒçš„ç»“æ„åŒ–ä¿¡æ¯
3. **å¼ºå¤§çš„æœç´¢èƒ½åŠ›**ï¼šé€šè¿‡æ ‡ç­¾ã€å…³é”®è¯ã€JSONB æŸ¥è¯¢å®ç°ç²¾å‡†æœç´¢
4. **ä¸ªæ€§åŒ–æ¨è**ï¼šåŸºäºåˆ†ç±»å’Œæ ‡ç­¾çš„ç›¸ä¼¼å†…å®¹æ¨è
5. **æ•°æ®åˆ†ææ”¯æŒ**ï¼šç»Ÿè®¡ä¸åŒèµ›é“å’Œç±»å‹çš„å†…å®¹åˆ†å¸ƒ

**ä¸‹ä¸€æ­¥**ï¼š
1. æ‰§è¡Œè¿ç§» SQL åˆ›å»ºæ–°å­—æ®µ
2. æ›´æ–° TypeScript Schema
3. ä¿®æ”¹ N8N INSERT SQL
4. å‰ç«¯/ä¸Šæ¸¸æ·»åŠ åˆ†ç±»ä¿¡æ¯è¾“å…¥
5. æ›´æ–°æŸ¥è¯¢ SQL åŒ…å«åˆ†ç±»ä¿¡æ¯
